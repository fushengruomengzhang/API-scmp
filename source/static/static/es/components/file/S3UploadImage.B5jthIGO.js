import j from"./S3Upload.pfC_Rle4.js";import{M as B,r as t,a as h,o as d,e as l,c as f,d as _,w as c,l as w,m as g,f as U,F as I}from"../../vue.B9VI7CMM.js";import{i as P}from"../../browser.BzWLnoYn.js";import{_ as S}from"../address/S3Address.C-l0MtE3.js";import"../../resources/global/global.api.CrVXT8XL.js";import"../../mitt.C1xD_ZTF.js";const F=""+new URL("../../../js/image-compression.IJag5AvL.js",import.meta.url).href,z={name:"S3UploadImage",extends:j,mixins:[],components:{VueCropper:B},emits:[],props:{accept:{type:String,default:".jpeg,.jpg,.png,.webp"},cropper:{type:Object,default:()=>({open:!1})},compress:{type:Object,default:()=>({enable:!1,properties:[]})}},data(){return{showViewer:!1,showCropper:!1,cropperCache:void 0,compressLibURL:F}},methods:{beforeUpload(e){if(this.hideUpload=!0,!this.cropper.open&&!this.compress.enable)return!0;if(this.compress.enable)return new Promise((r,i)=>{const m=this.compress.properties.map(o=>P(e,{...o,libURL:this.compressLibURL}));Promise.allSettled(m).then(o=>{const s=o.filter(({status:p})=>p==="rejected").map(({reason:p})=>p);if(s&&s.length>0)return i(s);r(e)})});if(this.cropper.open){const r=new FileReader;return r.onload=i=>{const{uid:m,name:o,type:s}=e,p=window.URL.createObjectURL(new Blob([i.target.result]));this.cropperCache={uid:m,name:o,type:s,cropperUrl:p},this.showCropper=this.cropper.open,this.hideUpload=!0},r.readAsArrayBuffer(e),!1}return!0},cropperClose(){this.hideUpload=!1},cropperClosed(){this.cropperCache=void 0},cancel(){this.showCropper=!1},confirm(){this.$refs.imgCropper.getCropBlob(e=>{const r=window.URL.createObjectURL(e),{uid:i,name:m,type:o}=this.cropperCache,s=new File([e],m,{type:o}),p={file:s,filename:"file"};new Promise((a,u)=>this.upload.upload(p,a,u)).then(a=>{const u={name:m,response:a,raw:s,uid:i,url:r,status:"success",size:s.size};this.onSuccess(a,u,this.fileList.add(u)),this.showCropper=!1})})}}},N=["src"],O={key:1,class:"el-upload-list__item-actions"},q=["onClick"],A=["onClick"];function D(e,r,i,m,o,s){const p=t("Plus"),a=t("el-icon"),u=t("zoom-in"),b=t("Delete"),k=t("el-progress"),v=t("el-upload"),y=t("el-image-viewer"),L=t("vue-cropper"),C=t("el-button"),V=t("el-dialog");return d(),h(I,null,[l(v,g({ref:"uploadImage",class:{"hide-upload":e.hide},"list-type":"picture-card"},e.$attrs,{"file-list":e.fileList,action:e.action,limit:e.limit,accept:i.accept,"before-upload":s.beforeUpload,"http-request":e.httpRequest,"on-success":e.onSuccess,"on-remove":e.onRemove}),{file:c(({file:n})=>[n.status==="success"?(d(),h("img",{key:0,src:e.buildFileUrl(n.url),style:{width:"100%",height:"auto"},alt:""},null,8,N)):_("",!0),n.status==="success"?(d(),h("span",O,[w("span",{class:"el-upload-list__item-preview",onClick:R=>o.showViewer=n.url},[l(a,null,{default:c(()=>[l(u)]),_:1})],8,q),w("span",{class:"el-upload-list__item-delete",onClick:R=>e.$refs.uploadImage.handleRemove(n)},[l(a,null,{default:c(()=>[l(b)]),_:1})],8,A)])):(d(),f(k,{key:2,type:"circle",percentage:n.percentage},null,8,["percentage"]))]),default:c(()=>[l(a,{class:"avatar-uploader-icon"},{default:c(()=>[l(p)]),_:1})]),_:1},16,["class","file-list","action","limit","accept","before-upload","http-request","on-success","on-remove"]),o.showViewer?(d(),f(y,{key:0,"url-list":e.getPreviewImages(o.showViewer),onClose:r[0]||(r[0]=n=>o.showViewer=!1)},null,8,["url-list"])):_("",!0),l(V,{modelValue:o.showCropper,"onUpdate:modelValue":r[1]||(r[1]=n=>o.showCropper=n),title:"图片裁剪",onClose:s.cropperClose,onClosed:s.cropperClosed},{footer:c(()=>[l(C,{onClick:s.cancel},{default:c(()=>[U("取消")]),_:1},8,["onClick"]),l(C,{type:"primary",onClick:s.confirm},{default:c(()=>[U("完成")]),_:1},8,["onClick"])]),default:c(()=>[o.showCropper?(d(),f(L,g({key:0,ref:"imgCropper",class:"img-cropper"},i.cropper,{img:o.cropperCache.cropperUrl}),null,16,["img"])):_("",!0)]),_:1},8,["modelValue","onClose","onClosed"])],64)}const H=S(z,[["render",D],["__scopeId","data-v-97c5778f"]]);export{H as default};
