import j from"./S3Upload.pfC_Rle4.js";import{N as B,r as t,a as h,o as d,e as l,c as f,d as _,w as c,l as w,m as g,f as U,F as P,O as I}from"../../.store.ssRjOe-B.js";import{_ as S}from"../address/S3Address.Dp8cFelg.js";import"../../resources/global/global.api.CrVXT8XL.js";const F=""+new URL("../../../js/image-compression.DJfHAV6C.js",import.meta.url).href,N={name:"S3UploadImage",extends:j,mixins:[],components:{VueCropper:B},emits:[],props:{accept:{type:String,default:".jpeg,.jpg,.png,.webp"},cropper:{type:Object,default:()=>({open:!1})},compress:{type:Object,default:()=>({enable:!1,properties:[]})}},data(){return{showViewer:!1,showCropper:!1,cropperCache:void 0,compressLibURL:F}},methods:{beforeUpload(e){if(this.hideUpload=!0,!this.cropper.open&&!this.compress.enable)return!0;if(this.compress.enable)return new Promise((r,a)=>{const m=this.compress.properties.map(o=>I(e,{...o,libURL:this.compressLibURL}));Promise.allSettled(m).then(o=>{const s=o.filter(({status:n})=>n==="rejected").map(({reason:n})=>n);if(s&&s.length>0)return a(s);r(e)})});if(this.cropper.open){const r=new FileReader;return r.onload=a=>{const{uid:m,name:o,type:s}=e,n=window.URL.createObjectURL(new Blob([a.target.result]));this.cropperCache={uid:m,name:o,type:s,cropperUrl:n},this.showCropper=this.cropper.open,this.hideUpload=!0},r.readAsArrayBuffer(e),!1}return!0},cropperClose(){this.hideUpload=!1},cropperClosed(){this.cropperCache=void 0},cancel(){this.showCropper=!1},confirm(){this.$refs.imgCropper.getCropBlob(e=>{const r=window.URL.createObjectURL(e),{uid:a,name:m,type:o}=this.cropperCache,s=new File([e],m,{type:o}),n={file:s,filename:"file"};new Promise((i,u)=>this.upload.upload(n,i,u)).then(i=>{const u={name:m,response:i,raw:s,uid:a,url:r,status:"success",size:s.size};this.onSuccess(i,u,this.fileList.add(u)),this.showCropper=!1})})}}},O=["src"],z={key:1,class:"el-upload-list__item-actions"},q=["onClick"],A=["onClick"];function D(e,r,a,m,o,s){const n=t("Plus"),i=t("el-icon"),u=t("zoom-in"),b=t("Delete"),k=t("el-progress"),v=t("el-upload"),y=t("el-image-viewer"),V=t("vue-cropper"),C=t("el-button"),L=t("el-dialog");return d(),h(P,null,[l(v,g({ref:"uploadImage",class:{"hide-upload":e.hide},"list-type":"picture-card"},e.$attrs,{"file-list":e.fileList,action:e.action,limit:e.limit,accept:a.accept,"before-upload":s.beforeUpload,"http-request":e.httpRequest,"on-success":e.onSuccess,"on-remove":e.onRemove}),{file:c(({file:p})=>[p.status==="success"?(d(),h("img",{key:0,src:e.buildFileUrl(p.url),style:{width:"100%",height:"auto"},alt:""},null,8,O)):_("",!0),p.status==="success"?(d(),h("span",z,[w("span",{class:"el-upload-list__item-preview",onClick:R=>o.showViewer=p.url},[l(i,null,{default:c(()=>[l(u)]),_:1})],8,q),w("span",{class:"el-upload-list__item-delete",onClick:R=>e.$refs.uploadImage.handleRemove(p)},[l(i,null,{default:c(()=>[l(b)]),_:1})],8,A)])):(d(),f(k,{key:2,type:"circle",percentage:p.percentage},null,8,["percentage"]))]),default:c(()=>[l(i,{class:"avatar-uploader-icon"},{default:c(()=>[l(n)]),_:1})]),_:1},16,["class","file-list","action","limit","accept","before-upload","http-request","on-success","on-remove"]),o.showViewer?(d(),f(y,{key:0,"url-list":e.getPreviewImages(o.showViewer),onClose:r[0]||(r[0]=p=>o.showViewer=!1)},null,8,["url-list"])):_("",!0),l(L,{modelValue:o.showCropper,"onUpdate:modelValue":r[1]||(r[1]=p=>o.showCropper=p),title:"图片裁剪",onClose:s.cropperClose,onClosed:s.cropperClosed},{footer:c(()=>[l(C,{onClick:s.cancel},{default:c(()=>[U("取消")]),_:1},8,["onClick"]),l(C,{type:"primary",onClick:s.confirm},{default:c(()=>[U("完成")]),_:1},8,["onClick"])]),default:c(()=>[o.showCropper?(d(),f(V,g({key:0,ref:"imgCropper",class:"img-cropper"},a.cropper,{img:o.cropperCache.cropperUrl}),null,16,["img"])):_("",!0)]),_:1},8,["modelValue","onClose","onClosed"])],64)}const T=S(N,[["render",D],["__scopeId","data-v-79d6b513"]]);export{T as default};
