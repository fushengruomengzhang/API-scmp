import{D as p}from"../../resources/util/div.contenteditable.CoSHwT0-.js";import{M as g}from"../../resources/util/map.DsJxN4sz.js";import{s as h}from"../../resources/util/snowflake.util.CMOmz3k-.js";import{_ as w}from"../address/S3Address.C-l0MtE3.js";import{a as x,o as F,l as b}from"../../vue.B9VI7CMM.js";import"../../resources/util/machine.code.util.H1Gamunq.js";import"../../resources/util/crypto.util.De05Bpu1.js";import"../../crypto.tqJ8oQci.js";import"../../antlr4.BZgrZd6q.js";import"../../mitt.C1xD_ZTF.js";const y={name:"S3DivInput",extends:{},mixins:[],components:{},emits:["update:modelValue"],props:{modelValue:{type:Array,default:void 0},placeholder:{type:String,default:"请输入内容"},imgConfig:{type:Object,default:()=>({maxWidth:150})},uploadFn:{type:Function,default:(t,n,i,e)=>i()},onAtFunction:{type:Function,default:t=>Promise.resolve()},buildFileUrl:{type:Function,default:t=>t},autoFocus:{type:Boolean,default:!1}},data(){return{divContenteditable:void 0,result:[],idPrefix:"_",nodeDetail:void 0,dpr:window.devicePixelRatio||1}},computed:{font(){const t=window.getComputedStyle(this.$refs.editable),n=t.getPropertyValue("font-size"),i=t.getPropertyValue("font-family");return`${n} ${i}`}},watch:{modelValue(t,n){t||(this.divContenteditable.restContent(),this.nodeDetail.deleteAll())}},mounted(){const t={uploadFn:this.upload,analysisNodeFn:this.analysisNodeFn,contentFn:this.contentFn,atFn:this.onAt,autoFocusFn:this.autoFocusFn};this.divContenteditable=new p(this.$refs.editable,t),this.nodeDetail=new g},methods:{autoFocusFn(){return this.autoFocus},setExpression(t){const n=t.split("-").map(e=>parseInt(e,16)),i=document.createTextNode(String.fromCodePoint(...n));this.divContenteditable.setExpression(i)},contentFn(t){this.$emit("update:modelValue",t)},onAt(t,n,i){this.onAtFunction(t).then(([e,d])=>{const s=document.createElement("canvas"),o=s.getContext("2d");o.font=this.font,o.fillStyle="#070707";const l="@"+d,a=8,{width:r,fontBoundingBoxAscent:u,fontBoundingBoxDescent:m}=o.measureText(l),c=u+m;s.width=(r+a)*this.dpr,s.height=c*this.dpr,o.scale(this.dpr,this.dpr),o.font=this.font,o.fillStyle="#070707",o.textAlign="center",o.textBaseline="middle",o.fillText(l,(r+a)/2,c/2,r+a);const f=Object.assign(new Image,{src:s.toDataURL("image/png"),width:r+a,height:c,id:h(this.idPrefix)});this.nodeDetail.put(f.id,{msgType:"at",content:d,params:{atUserId:e}}),n(f)}).catch(e=>i())},analysisNodeFn(t){return t.nodeType===3?t.data?{msgType:"text",content:t.data}:void 0:this.nodeDetail.get(t.id)},upload(t,n){return new Promise(i=>{n==="image"?new Promise((e,d)=>this.uploadFn(t,this.imgConfig,e,d)).then(e=>i(this.buildImgNode(t,e))):n==="video"?i(this.buildVideoNode(t,{filePath:"filePath",fileName:"fileName",fileSize:"fileSize",fileDetail:"fileDetail"})):(console.log(n),i())})},buildImgNode(t,n){const{src:i,filePath:e,fileSize:d,fileName:s,fileDetail:o}=n,l=Object.assign(new Image,{src:i,id:h(this.idPrefix)});return this.nodeDetail.put(l.id,{msgType:"img",content:s,params:{filePath:e,fileName:s,fileSize:d,fileDetail:o}}),l},buildVideoNode(t,n){const i=Object.assign(document.createElement("canvas"),{width:200,height:65}),e=i.getContext("2d");i.width=i.width*this.dpr,i.height=i.height*this.dpr,e.scale(this.dpr,this.dpr),e.fillStyle="#fff",e.fillRect(0,0,200,65),e.font=this.font,e.fillStyle="#070707",this.drawTruncatedText(e,t.name,5,20,140),this.drawTruncatedText(e,t.size,5,20*3,140),e.beginPath(),e.moveTo(162,1),e.lineTo(190,1),e.lineTo(183,13),e.lineTo(169,13),e.closePath(),e.stroke(),e.strokeRect(155,14,42,50),e.beginPath(),e.moveTo(160,30),e.lineTo(160,50),e.closePath(),e.stroke();const d=i.toDataURL("image/png"),s=Object.assign(new Image,{src:d,width:200,height:65,id:h(this.idPrefix)}),{filePath:o,fileSize:l,fileName:a,fileDetail:r}=n;return this.nodeDetail.put(s.id,{msgType:"video",content:a,params:{filePath:o,fileName:a,fileSize:l,fileDetail:r}}),s},drawTruncatedText(t,n,i,e,d){let s="...",o=0,l=t.measureText(s).width;for(let a=0;a<n.length;a++)if(o+=t.measureText(n[a]).width,o+l>d){t.fillText(n.substring(0,a)+s,i,e);return}t.fillText(n,i,e)}}},T={class:"s3-div-input"},P=["placeholder"];function v(t,n,i,e,d,s){return F(),x("div",T,[b("div",{ref:"editable",class:"editable",placeholder:i.placeholder},null,8,P)])}const j=w(y,[["render",v],["__scopeId","data-v-a5fbd733"]]);export{j as default};
