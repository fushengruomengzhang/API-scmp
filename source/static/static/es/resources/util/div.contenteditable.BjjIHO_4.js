class u{constructor(t,{uploadFn:e,analysisNodeFn:i,contentFn:n,atFn:s,autoFocusFn:o}){this.upload=e||(r=>new Promise(d=>d())),this.analysisNodeFn=i,this.contentFn=n,this.atFn=s,this.editor=t,this.isComposing=!1,this.history=[{nodes:[],endOffset:0,offset:void 0,elementIndex:void 0}],this.historyIndex=0,this.controller=void 0,this.historyController=void 0,this.blurRange=void 0,this.autoFocusFn=o,this.initEditor()}initEditor(){this.editor.setAttribute("contenteditable",!0),this.editor.setAttribute("spellCheck",!1),this.editor.addEventListener("paste",t=>this.pasteListener(t)),this.editor.addEventListener("input",t=>this.inputListener(t)),this.editor.addEventListener("keydown",t=>this.keydownListener(t)),this.editor.addEventListener("compositionstart",t=>this.compositionstartListener(t)),this.editor.addEventListener("compositionend",t=>this.compositionendListener(t)),this.editor.addEventListener("blur",t=>this.blurListener(t)),this.editor.focus({preventScroll:!0})}blurListener(t){const e=window.getSelection();!e.rangeCount>0||(this.blurRange=e.getRangeAt(0),this.autoFocus())}autoFocus(){setTimeout(()=>{if(!this.blurRange)return;const t=window.getSelection();!t.rangeCount>0||!this.autoFocusFn||!this.autoFocusFn()||(t.removeAllRanges(),t.addRange(this.blurRange))},500)}pasteListener(t){const e=t.clipboardData||window.clipboardData,{items:[{kind:i,type:n}],files:[s]}=e;i==="string"||i==="file"&&(t.preventDefault(),this.pasteFile(s,n))}pasteFile(t,e){const i=window.getSelection();if(!i.rangeCount>0)return;const n=i.getRangeAt(0);n.deleteContents();const s=e.replace(/^([a-z]+)\/(.*)/,"$1");this.upload(t,s).then(o=>{if(!o||!(o instanceof Node))return console.warn("暂不支持类型为["+e+"]的文件处理");n.insertNode(o),n.setStartAfter(o),this.buildContent(),this.saveHistory(o)})}pasteText(t){const e=window.getSelection();if(!e.rangeCount>0)return;const i=e.getRangeAt(0);i.deleteContents();const n=document.createTextNode(t);i.insertNode(n),i.setStartAfter(n),this.buildContent(),this.saveHistory(n,t.length)}keydownListener(t){t.metaKey||t.ctrlKey?t.code==="KeyZ"&&t.shiftKey||t.code==="KeyY"?this.redo(t):t.code==="KeyZ"&&this.undo(t):t.shiftKey&&t.code==="Digit2"&&this.atFn&&this.onShiftAt(t)}setExpression(t){if(!this.blurRange)return;const e=window.getSelection();!e.rangeCount>0||!t||!(t instanceof Node)||(this.blurRange.insertNode(t),this.blurRange.setStartAfter(t),e.removeAllRanges(),e.addRange(this.blurRange),this.buildContent(),this.saveHistory(t))}onShiftAt(t){if(!this.atFn)return;const e=window.getSelection();if(!e.rangeCount>0)return;t.preventDefault();const i=e.getRangeAt(0),n=document.createElement("span");i.insertNode(n);const s=document.createTextNode("@");i.insertNode(s),e.removeAllRanges(),new Promise((o,r)=>this.atFn(n,o,r)).then(o=>{n.remove(),!(!o||!(o instanceof Node))&&(s.remove(),i.insertNode(o),i.setStartAfter(o),e.removeAllRanges(),e.addRange(i),this.buildContent(),this.saveHistory(o))}).catch(()=>{n.remove(),i.setStartAfter(s),e.removeAllRanges(),e.addRange(i),this.buildContent(),this.saveHistory(s)})}compositionstartListener(t){this.isComposing=!0}compositionendListener(t){this.isComposing=!1,this.buildContent(),this.saveHistory()}inputListener(t){this.isComposing||(this.buildContent(),this.saveHistory())}saveHistory(t,e){this.historyController&&!this.historyController.aborted&&this.historyController.abort(),this.historyController=new AbortController,new Promise((i,n)=>{this.historyController.signal.addEventListener("abort",n);const s=window.getSelection();if(!s.rangeCount>0)return;let{endOffset:o,endContainer:r}=s.getRangeAt(0);const d=Array.from(this.editor.childNodes);r===this.editor&&(r=d[o-1]);const h=d.indexOf(t||r),l=d.map(a=>a.cloneNode(!0));this.history.splice(this.historyIndex+1),this.history.push({nodes:l,endOffset:o,offset:e,elementIndex:h}),this.historyIndex=this.history.length-1,this.historyController=void 0,i()}).catch(i=>console.error("save history:reject"))}undo(t){t.preventDefault(),this.historyIndex>0&&(this.historyIndex--,this.operationHtml())}redo(t){t.preventDefault(),this.historyIndex<this.history.length-1&&(this.historyIndex++,this.operationHtml())}operationHtml(){const{nodes:t,endOffset:e,offset:i,elementIndex:n}=this.history[this.historyIndex];this.editor.innerHTML="",t&&t.length&&t.forEach(s=>this.editor.appendChild(s.cloneNode(!0))),this.restSelection(i||e,n),this.buildContent()}restSelection(t,e=0){const i=this.editor.childNodes[e]||this.editor.childNodes[e-1];if(!i)return;const n=window.getSelection(),s=n.getRangeAt(0);n.removeAllRanges(),i instanceof Text?(s.setStart(i,Math.min(t,i.data.length)),s.collapse(!0)):(s.collapse(!0),s.setStartAfter(i)),n.addRange(s)}buildContent(){this.contentFn&&(this.controller&&!this.controller.aborted&&this.controller.abort(),this.controller=new AbortController,new Promise((t,e)=>{this.controller.signal.addEventListener("abort",e);const i=Array.from(this.editor.childNodes).map(n=>this.analysisNodeFn(n)).filter(n=>n);this.controller=void 0,t(i)}).then(t=>this.contentFn(t)).catch(t=>console.error(t)))}restContent(){this.editor.innerHTML="",this.history=[{nodes:[],endOffset:0,offset:void 0,elementIndex:void 0}],this.historyIndex=0}}export{u as D};
