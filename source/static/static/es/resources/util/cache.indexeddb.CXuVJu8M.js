class S{constructor(r,s,t){this.db=null,this.dbName=r,this.tables=s,this.init=!1,this.res=[],this.version=t||this.tables.length}initDb(){return this.db?Promise.resolve(this.db):this.init&&!this.db?new Promise(r=>this.res.push(r)):(this.init=!0,new Promise((r,s)=>{const t=window.indexedDB.open(this.dbName,this.version);t.onerror=o=>s(o.target.error),t.onsuccess=o=>{this.db=o.target.result,r(this.db),this.res.forEach(i=>i(this.db))},t.onupgradeneeded=o=>{this.db=o.target.result;const i=this.tables.map(({store:{storeName:e}})=>e),a=Array.from(this.db.objectStoreNames);a.filter(e=>!i.includes(e)).forEach(e=>this.db.deleteObjectStore(e)),this.tables.filter(({store:{storeName:e}})=>!a.includes(e)).forEach(({store:{storeName:e,storeOptions:n},index:{indexName:c,keyPath:b,indexOptions:l}})=>{const h=this.db.createObjectStore(e,n);c&&h.createIndex(c,b,l)})}}))}add(r,s){return new Promise((t,o)=>{this.initDb().then(i=>{let n=i.transaction(s,"readwrite").objectStore(s).add(r);n.onsuccess=c=>t(c),n.onerror=c=>o(c)})})}update(r,s,t){return new Promise((o,i)=>{this.get(r,t).then(a=>{if(!a)return i("未查询到对应的数据,更新失败");this.initDb().then(e=>{let b=e.transaction(t,"readwrite").objectStore(t).put(s);b.onsuccess=l=>o(l.target.result),b.onerror=l=>i(l)})})})}delete(r,s,t){return new Promise((o,i)=>{this.initDb().then(a=>{let c=a.transaction(t,"readwrite").objectStore(t).index(r).openCursor(s);c.onerror=b=>i(b),c.onsuccess=b=>{let l=b.target.result;if(!l)return;let h=l.delete();h.onerror=u=>i(u),h.onsuccess=u=>o(u),l.continue()}})})}deleteAll(r){return new Promise((s,t)=>{this.initDb().then(o=>{const e=o.transaction(r,"readwrite").objectStore(r).clear();e.onsuccess=n=>s(n),e.onerror=n=>t(n)})})}get(r,s){return new Promise((t,o)=>{this.initDb().then(i=>{let n=i.transaction(s,"readonly").objectStore(s).get(r);n.onsuccess=c=>t(c.target.result),n.onerror=c=>o(c)})})}getAll(r){return new Promise((s,t)=>{this.initDb().then(o=>{let e=o.transaction(r,"readonly").objectStore(r).getAll();e.onsuccess=n=>s(n.target.result),e.onerror=n=>t(n)})})}}export{S as C};
