import{C as P}from"../../../../components/doc/S3XmlEditor.BCtgNbeo.js";import{a as V,l as h,e as d,c,d as u,w as s,J as A,a8 as B,r as o,z as I,o as l,f as D,t as O,j as E}from"../../../../.store.ssRjOe-B.js";import{r as U}from"../../../../stores/request.server.apbYzn03.js";import{e as F,s as _,l as N,u as R}from"../../../../resources/global/global.util.BDToHPEB.js";import{m as j}from"../util/request.utils.CJX_gtFp.js";import q from"../../../../components/scroll/S3Scroll._gxLu3iz.js";import{_ as z}from"../../../../components/address/S3Address.Dp8cFelg.js";import"../../../../components/doc/mybatis-3-mapper.Dln2i63Z.js";import"../../../../resources/util/map.DsJxN4sz.js";import"../../../../resources/util/cache.indexeddb.CXuVJu8M.js";import"../../../../resources/util/timer.util.DJ34cZ81.js";import"../../../../resources/util/crypto.util.C7ecaPji.js";import"../../../../../../public.scmp.config.js";const J={name:"ApiDocEditor",components:{S3Scroll:q},setup(){const{isShare:e,apiDocDetail:t,domainOptions:a,refreshDocTree:i}=B(U());return{isShare:e,apiDocDetail:t,domainOptions:a,refreshDocTree:i}},emits:[],props:{showApiSelect:{type:Boolean,default:!0}},data(){return{codemirror:void 0,cascaderProps:{value:"id",label:"title",checkStrictly:!0,emitPath:!1,lazy:!0,lazyLoad:this.findByParentId,leaf:(e,t)=>e.type==="doc",disabled:(e,t)=>e.type==="doc"}}},computed:{sharePath(){const{origin:e,pathname:t}=window.location;return R(e,t)+`#/shareRequest?id=${this.apiFlag}`},disabled(){return!this.apiDocDetail.api_ids},isUp(){return!!this.apiDocDetail.id},apiFlag(){return this.apiDocDetail.flag},copyOptions(){return{getElement:e=>e.parentElement,options:{text:e=>this.sharePath},onSuccess:e=>this.$message({type:"success",showClose:!0,message:"路径已生成",center:!0})}}},watch:{apiFlag:{immediate:!0,handler(e,t){e&&this.initContent()}}},created(){},mounted(){const e={Tab:this.onTabClick},t={readOnly:this.isShare,lineNumbers:!0,line:!0,autoRefresh:!0,matchTags:!0,autoCloseTags:!0,matchBrackets:!0,autoCloseBrackets:!0,scrollbarStyle:"overlay",extraKeys:e};this.codemirror=A(P.fromTextArea(this.$refs.editor,t)),this.codemirror.on("change",(a,i)=>this.apiDocDetail.content=a.getValue()),_(.01).then(a=>this.codemirror.refresh())},beforeUnmount(){},methods:{initContent(){this.apiDocDetail.content?this.$nextTick(()=>this.codemirror.setValue(this.apiDocDetail.content)):this.findAll("tb_request_api.find",{ids:this.apiDocDetail.api_ids}).then(e=>this.$nextTick(this.codemirror.setValue(j(e.data))))},findByParentId(e,t){if(e.level===0&&(this.apiDocDetail.id||this.apiDocDetail.parent_id)){const a=[this.apiDocDetail.id,this.apiDocDetail.parent_id].filter(Boolean);this.findAll("tb_api_docs.findTreeByIdIn",{ids:a}).then(i=>t(N(i.data,"id","parent_id")))}else this.findAll("tb_api_docs.find",{parentId:e.data.id||0}).then(a=>t(a.data))},handleCommand(){},onTabClick(e){e.replaceSelection("    ","end"),_(.001).then(t=>this.codemirror.focus())},updateOrSaveApiDoc(){new Promise((e,t)=>{if(this.apiDocDetail.type!=="doc")return e([this.apiDocDetail.id?"update":"save",this.apiDocDetail,this.apiDocDetail.id?"更新成功":"新建成功"]);const a=this.apiDocDetail.flag=F(this.apiDocDetail.api_ids.sort().join(","));this.findOne("tb_api_docs.find",{flag:a}).then(i=>{if(!i.data.id)return e([this.apiDocDetail.id?"update":"save",this.apiDocDetail,this.apiDocDetail.id?"更新成功":"新建成功"]);if(this.apiDocDetail.id&&i.data.id!==this.apiDocDetail.id)return t(`该组API已关联( ${i.data.title} )`);if(this.apiDocDetail.id&&i.data.id===this.apiDocDetail.id)return e(["update",this.apiDocDetail,"更新成功"]);this.$confirm(`该组API已存在对应的使用文档( ${i.data.title} ),是否覆盖?`,"警告",{type:"warning"}).then(r=>Promise.resolve(this.apiDocDetail.id=r.data.id)).then(r=>e(["update",this.apiDocDetail,"更新成功"])).catch(r=>{})})}).then(([e,t,a])=>{(e==="update"?this.update("tb_api_docs.update",t):this.save("tb_api_docs.save",t)).then(r=>{this.$message({type:"success",showClose:!0,message:a,center:!0}),e==="save"&&(this.apiDocDetail.id=r.data),this.refreshDocTree(this.apiDocDetail),this.showForm=!1})}).catch(e=>this.$message({type:"warning",showClose:!0,message:e,center:!0}))}}},K={class:"api-doc"},L={class:"api-doc-top"},M={class:"operation"},G=["value"];function H(e,t,a,i,r,n){const f=o("el-cascader"),y=o("el-input"),b=o("Edit"),w=o("Plus"),m=o("el-icon"),g=o("Share"),C=o("el-text"),v=o("el-dropdown-item"),S=o("el-dropdown-menu"),k=o("el-dropdown"),T=o("s3-scroll"),x=I("copy");return l(),V("div",K,[h("div",L,[i.isShare?u("",!0):(l(),c(f,{class:"doc-folder",placeholder:"请选择目录",key:i.apiDocDetail.id,modelValue:i.apiDocDetail.parent_id,"onUpdate:modelValue":t[0]||(t[0]=p=>i.apiDocDetail.parent_id=p),props:r.cascaderProps},null,8,["modelValue","props"])),h("div",M,[d(y,{class:"doc-title",disabled:i.isShare,placeholder:"请输入名称",modelValue:i.apiDocDetail.title,"onUpdate:modelValue":t[1]||(t[1]=p=>i.apiDocDetail.title=p)},null,8,["disabled","modelValue"]),i.isShare?u("",!0):(l(),c(k,{key:0,class:"operation-dropdown",disabled:n.disabled,"split-button":"",type:"primary",onCommand:n.handleCommand,onClick:n.updateOrSaveApiDoc},{dropdown:s(()=>[d(S,null,{default:s(()=>[d(v,{disabled:!n.isUp,command:"shareDocument"},{default:s(()=>[E((l(),c(C,null,{default:s(()=>[d(m,null,{default:s(()=>[d(g)]),_:1}),D("分享文档")]),_:1})),[[x,n.copyOptions]])]),_:1},8,["disabled"])]),_:1})]),default:s(()=>[d(m,null,{default:s(()=>[n.isUp?(l(),c(b,{key:0})):(l(),c(w,{key:1}))]),_:1}),D(O(n.isUp?"更新":"新建")+" ",1)]),_:1},8,["disabled","onCommand","onClick"]))])]),d(T,{class:"editor-wrapper"},{default:s(()=>[h("textarea",{ref:"editor",class:"editor",value:i.apiDocDetail.content},null,8,G)]),_:1})])}const ne=z(J,[["render",H],["__scopeId","data-v-951e0086"]]);export{ne as default};
