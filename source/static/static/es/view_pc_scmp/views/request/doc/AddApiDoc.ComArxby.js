import{e as c,l as p}from"../../../../resources/global/global.util.CdGU-cda.js";import{r as _}from"../../../../stores/request.server.Jl9Oinz8.js";import{_ as V}from"../../../../components/address/S3Address.C-l0MtE3.js";import{s as b}from"../../../../pinia.C4zkjZtA.js";import{c as m,w as A,r,o as u,e as l,d as P}from"../../../../vue.B9VI7CMM.js";const I={name:"AddApiDoc",components:{},setup(){const{refreshDocTree:e}=b(_());return{refreshDocTree:e}},emits:["update:modelValue","update:model"],props:{modelValue:{type:Boolean,default:!1},model:{type:Object,default:()=>({})},parentIds:{type:[Array,Number],default:()=>[]}},data(){return{typeOptions:[{label:"folder",name:"目录"},{label:"doc",name:"文档"}],cascaderProps:{value:"id",label:"title",checkStrictly:!0,emitPath:!1,lazy:!0,lazyLoad:this.findByParentId,leaf:(e,t)=>e.type==="doc",disabled:(e,t)=>e.type==="doc"},apiProps:{value:"id",label:"name",emitPath:!1,checkStrictly:!0,multiple:!0,lazy:!0,lazyLoad:this.findApiByParentId,leaf:(e,t)=>e.type==="api",disabled:(e,t)=>e.type==="folder"}}},computed:{showForm:{get(){return this.modelValue},set(e,t){this.$emit("update:modelValue",e)}},entity:{get(){return this.model},set(e){this.$emit("update:model",e)}},rules(){let e={type:[{required:!0,message:"请选择类型"}],title:[{required:!0,message:"请输入名称"}]};return this.entity.type==="doc"&&(e.api_ids=[{required:!0,message:"请选择关联的API文档"}]),e}},watch:{},created(){},mounted(){},methods:{findByParentId(e,t){if(e.level===0&&(this.entity.id||this.entity.parent_id)){const d=[this.entity.id,this.entity.parent_id].filter(Boolean);this.findAll("tb_api_docs.findTreeByIdIn",{ids:d}).then(a=>t(p(a.data,"id","parent_id")))}else this.findAll("tb_api_docs.find",{parentId:e.data.id||0}).then(d=>t(d.data))},findApiByParentId(e,t){var d;e.level===0&&((d=this.entity.api_ids)==null?void 0:d.length)>0?this.findAll("tb_request_api.findTreeByIdIn",{ids:this.entity.api_ids}).then(a=>t(p(a.data,"id","parent_id"))):this.findAll("tb_request_api.find",{parentId:e.data.id||0}).then(a=>t(a.data))},commit(){new Promise((e,t)=>{if(this.entity.type!=="doc")return e([this.entity.id?"update":"save",this.entity,this.entity.id?"更新成功":"新建成功"]);const d=this.entity.flag=c(this.entity.api_ids.sort().join(","));this.findOne("tb_api_docs.find",{flag:d}).then(a=>{if(!a.data.id)return e([this.entity.id?"update":"save",this.entity,this.entity.id?"更新成功":"新建成功"]);if(this.entity.id&&a.data.id!==this.entity.id)return t(`该组API已关联( ${a.data.title} )`);if(this.entity.id&&a.data.id===this.entity.id)return e(["update",this.entity,"更新成功"]);this.$confirm(`该组API已存在对应的使用文档( ${a.data.title} ),是否覆盖?`,"警告",{type:"warning"}).then(s=>Promise.resolve(this.entity.id=s.data.id)).then(s=>e(["update",this.entity,"更新成功"])).catch(s=>{})})}).then(([e,t,d])=>{(e==="update"?this.update("tb_api_docs.update",t):this.save("tb_api_docs.save",t)).then(s=>{this.$message({type:"success",showClose:!0,message:d,center:!0}),e==="save"&&(this.entity.id=s.data),this.refreshDocTree(this.entity),this.showForm=!1})}).catch(e=>this.$message({type:"warning",showClose:!0,message:e,center:!0}))}}};function g(e,t,d,a,s,i){const y=r("s3-form-radio"),o=r("s3-form-cascader"),h=r("s3-form-input"),f=r("s3-dialog-form");return u(),m(f,{modelValue:i.showForm,"onUpdate:modelValue":t[4]||(t[4]=n=>i.showForm=n),model:i.entity,rules:i.rules,hideField:["type"],title:"新建/编辑",onConfirm:i.commit},{default:A(()=>[l(y,{label:"类型",prop:"type",modelValue:i.entity.type,"onUpdate:modelValue":t[0]||(t[0]=n=>i.entity.type=n),options:s.typeOptions},null,8,["modelValue","options"]),l(o,{label:"父级",prop:"parent_id",modelValue:i.entity.parent_id,"onUpdate:modelValue":t[1]||(t[1]=n=>i.entity.parent_id=n),props:s.cascaderProps},null,8,["modelValue","props"]),l(h,{label:"名称",prop:"title",modelValue:i.entity.title,"onUpdate:modelValue":t[2]||(t[2]=n=>i.entity.title=n),placeholder:"请输入名称"},null,8,["modelValue"]),i.entity.type==="doc"?(u(),m(o,{key:0,label:"API",prop:"api_ids",modelValue:i.entity.api_ids,"onUpdate:modelValue":t[3]||(t[3]=n=>i.entity.api_ids=n),props:s.apiProps,"show-all-levels":!1},null,8,["modelValue","props"])):P("",!0)]),_:1},8,["modelValue","model","rules","onConfirm"])}const T=V(I,[["render",g]]);export{T as A};
