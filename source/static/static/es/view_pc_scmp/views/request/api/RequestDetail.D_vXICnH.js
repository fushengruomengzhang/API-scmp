import{b as P,u as C,e as W,a as X,c as Y}from"../../../../resources/global/global.util.BDToHPEB.js";import{Q as Z}from"./detail/Query.iS-W-L7j.js";import{H as $}from"./detail/Header.ZXp1YzMC.js";import{B as ee}from"./detail/Body.4rgV3ihS.js";import{V as te}from"./detail/ViewApi.qlAuGtR9.js";import{D as se}from"./detail/Detail.wu9HawRU.js";import{d as ie,h as q,c as S,l as ae,e as le,f as ne,g as oe,u as re}from"../util/request.utils.CJX_gtFp.js";import{r as T}from"../../../../stores/request.server.apbYzn03.js";import{s as de}from"../../../../resources/util/snowflake.util.BS7FKuq4.js";import{a8 as ce,a as v,l as B,e as i,w as o,F as x,r as c,z as ue,o as g,h as E,c as A,f as D,t as F,K as he,d as O,j as I}from"../../../../.store.ssRjOe-B.js";import{_ as pe}from"../../../../components/address/S3Address.Dp8cFelg.js";const me={name:"RequestDetail",components:{Detail:se,ViewApi:te,Body:ee,Header:$,Query:Z},setup(){const{setResDetailOnce:t,initResDetailBatch:e,setResDetailBatch:l,setFileDetail:n,getFileDetail:a,removeFileDetail:s,setRunDetail:r,getRunDetail:u}=T(),{isShare:h,isSwagger:p,apiDetail:m,apiDetailClone:_,domainOptions:f,selectParentId:w,apiChangeDetail:y,refreshApiTree:b,batchReqNum:V}=ce(T());return{isShare:h,isSwagger:p,apiDetail:m,apiDetailClone:_,domainOptions:f,selectParentId:w,apiChangeDetail:y,refreshApiTree:b,setResDetailOnce:t,initResDetailBatch:e,setResDetailBatch:l,setFileDetail:n,removeFileDetail:s,getFileDetail:a,setRunDetail:r,getRunDetail:u,batchReqNum:V}},emits:[],props:{},data(){return{requestActive:"Detail",methodOptions:["GET","POST","PUT","DELETE"],showViewer:!1,clipboard:void 0,commandType:void 0,apiChangeDebounce:X((t,e)=>{!Y(t,e,["update_time","config.bodyType"])?this.apiChangeDetail.put(t.id,{nApi:t,oApi:e}):this.apiChangeDetail.remove(t.id)},.2)}},computed:{loading:{get(){return this.getRunDetail(this.apiDetail.id).loading||!1},set(t){this.setRunDetail(this.apiDetail.id,t)}},domain:{get(){return this.config.domain},set(t){this.config.domain=t}},header:{get(){return this.config.header||(this.config.header=[]),this.config.header},set(t){this.config.header=t}},requestPath(){const{contextPath:t,prefix:e,url:l}=this.config;return C(t,e,l)},shareDocUrl(){const{origin:t,pathname:e}=window.location,l=W(this.apiDetail.id.toString());return C(t,e)+`#/shareRequest?id=${l}`},copyMsg(){return this.commandType==="shareApi"?"分享链接已复制":"路径已复制"},isApiUpdate(){return!this.closeOperation&&this.apiChangeDetail.contains(this.apiDetail.id)&&this.apiDetail.id>0},copyOptions(){return{groupId:de("copy"),getElement:t=>t.parentElement,onSuccess:t=>this.$message({type:"success",showClose:!0,center:!0,message:this.copyMsg}),options:{text:t=>this.commandType==="shareApi"?this.shareDocUrl:this.requestPath}}},config(){return this.apiDetail.config},closeOperation(){return this.isShare||this.isSwagger}},watch:{apiDetail:{deep:!0,handler(t,e){this.closeOperation||this.apiChangeDebounce(t,this.apiDetailClone)}},config(t,e){this.initActive(t)}},created(){this.initActive(this.apiDetail.config)},mounted(){},beforeUnmount(){},methods:{initActive(t){const{method:e,query:l,queryBody:n,bodyDocument:a,formBodyDocument:s,urlBodyDocument:r}=t;e==="GET"?this.requestActive="Query":l&&l.length>0?this.requestActive="Query":(e==="POST"||n!=null&&n.length||a!=null&&a.length||s!=null&&s.length||r!=null&&r.length)&&(this.requestActive="Body")},operationCommand(t){if(this.commandType=t,t==="showViewer")return this.showViewer=!0;if(t==="updateApi")return this.updateApi(!0);if(t==="saveApi")return this.saveApi();if(t==="batchRequest")return this.handlerRequest("batchReq")},uploadFileChange(t,e){e==="append"?this.setFileDetail(this.apiDetail.id,t):e==="remove"&&this.removeFileDetail(this.apiDetail.id,t)},buildParam(t,e=1){const l=t.config,n=l.domain;if(!n)return this.$message({type:"error",showClose:!0,message:`[${t.name}]请选择环境`,center:!0});const a=C(n,l.contextPath,l.prefix,l.url),s=new URL(a).hostname,r=re(s),u=this.config.sse,h=this.getFileDetail(t.id),p={decryEncryAttempt:this.$decryEncryAttempt,responseType:"arraybuffer",ignore401:!0},m=r?ne(e,t,h):oe(a,e,this.$decryEncryAttempt,t,h);return{apiDetail:t,url:a,isLocalApi:r,isSSe:u,param:m,config:p}},buildReq(t,e=!0,l=1){const{apiDetail:n,url:a,isLocalApi:s,isSSe:r,param:u,config:h}=t,{method:p,headers:m,params:_,data:f}=u,w=e?b=>this.setResDetailOnce(n.id,q(b)):b=>this.setResDetailBatch(n.id,q(b),l);let y;return s?y=ae(p,a,m,_,f):r?y=le(this.$baseUrl,"POST","request/api/reqSSE",u,h,w):y=this.$http.post("request/api/req",u,h),y},reqApi(t,e,l){const n=this.buildParam(P(t));if(!n)return l();this.buildReq(n).then(a=>a?Promise.resolve(this.setResDetailOnce(t.id,q(a))):Promise.resolve()).then(a=>e?this.updateApi(!1,t):Promise.resolve()).catch(a=>this.setResDetailOnce(t.id,S(a))).finally(()=>l()||this.$message({message:"请求已执行",type:"success"}))},batchReqApi(t,e=1,l){let n,a=P(t);if(ie())n=Array.from({length:e},(r,u)=>this.buildParam(a,u+1));else{const r=this.buildParam(a,e);n=Array.from({length:e},(u,h)=>r)}this.initResDetailBatch(t.id);const s=Array.from({length:e},(r,u)=>this.buildReq(n[u],!1,u));Promise.allSettled(s).then(r=>{r.forEach(({reason:u,value:h,status:p},m)=>{if(p==="fulfilled")return h?this.setResDetailBatch(t.id,q(h),m):void 0;if(p==="rejected")return this.setResDetailBatch(t.id,S(u),m)})}).finally(()=>l()||this.$message({message:`${e}次请求已执行,请通过[结果N]查看响应内容`,type:"success"}))},handlerRequest(t){this.loading=!0;const e=this.apiDetail,l=this.isApiUpdate,n=this.batchReqNum;this.setRunDetail(e.id,!0),new Promise((a,s)=>{try{if(t==="default")return this.reqApi(e,l,a);if(t==="batchReq")return this.batchReqApi(e,n,a)}catch(r){s(r.message||"系统发生错误,请联系管理员")}}).catch(a=>{this.$message({type:"error",showClose:!0,message:a,center:!0})}).finally(()=>{this.setRunDetail(e.id,!1)})},updateApi(t,e){e=e||this.apiDetail;const l=[e.name,e.config.url].filter(Boolean).join(" ");this.update("tb_request_api.update",{...e,search:l}).then(n=>{this.apiDetailClone.id===e.id&&(this.apiDetailClone=P(e),this.apiDetailClone.search=l),e.search=l,this.apiChangeDetail.remove(e.id),t&&this.$message({message:"更新成功",type:"success"})})},saveApi(){if(!this.apiDetail.name)return this.$message({type:"error",showClose:!0,message:"请输入名称",center:!0});if(!this.config.method)return this.$message({type:"error",showClose:!0,message:"请选择方法",center:!0});if(!this.config.contextPath)return this.$message({type:"error",showClose:!0,message:"请输入contextPath",center:!0});if(!this.config.prefix)return this.$message({type:"error",showClose:!0,message:"请输入前缀",center:!0});if(!this.config.url)return this.$message({type:"error",showClose:!0,message:"请输入路径",center:!0});this.apiDetail.parent_id=this.selectParentId,this.apiDetail.search=[this.apiDetail.name,this.config.url].join(" "),this.apiDetail.type="api",this.save("tb_request_api.save",this.apiDetail).then(t=>this.refreshApiTree(this.apiDetail)).finally(()=>this.showForm=!1)}}},fe={class:"request-detail"},ge={class:"request-url"};function _e(t,e,l,n,a,s){const r=c("el-option"),u=c("el-text"),h=c("el-select"),p=c("el-input"),m=c("View"),_=c("el-icon"),f=c("el-dropdown-item"),w=c("s3-icon"),y=c("Plus"),b=c("Paperclip"),V=c("Share"),k=c("CopyDocument"),Q=c("el-dropdown-menu"),L=c("el-dropdown"),H=c("Detail"),R=c("el-tab-pane"),j=c("Header"),N=c("Query"),z=c("Body"),G=c("el-tabs"),M=c("ViewApi"),U=ue("copy");return g(),v(x,null,[B("div",fe,[B("div",ge,[i(h,{class:"method",modelValue:s.config.method,"onUpdate:modelValue":e[0]||(e[0]=d=>s.config.method=d)},{label:o(()=>[i(u,{class:"doc-method","data-text":s.config.method},{default:o(()=>[D(F(s.config.method),1)]),_:1},8,["data-text"])]),default:o(()=>[(g(!0),v(x,null,E(a.methodOptions,d=>(g(),A(r,{label:d,value:d},null,8,["label","value"]))),256))]),_:1},8,["modelValue"]),i(h,{class:"domain",modelValue:s.domain,"onUpdate:modelValue":e[1]||(e[1]=d=>s.domain=d),placeholder:"请选择环境"},{default:o(()=>[(g(!0),v(x,null,E(n.domainOptions,({domain:d,name:J,isLocal:K})=>(g(),A(r,{class:he({"local-env":K}),label:J,value:d},null,8,["class","label","value"]))),256))]),_:1},8,["modelValue"]),i(p,{class:"context-path",modelValue:s.config.contextPath,"onUpdate:modelValue":e[2]||(e[2]=d=>s.config.contextPath=d),placeholder:"context-path"},null,8,["modelValue"]),i(p,{class:"prefix",modelValue:s.config.prefix,"onUpdate:modelValue":e[3]||(e[3]=d=>s.config.prefix=d),placeholder:"prefix"},null,8,["modelValue"]),i(p,{class:"url",modelValue:s.config.url,"onUpdate:modelValue":e[4]||(e[4]=d=>s.config.url=d),placeholder:"path"},null,8,["modelValue"]),i(L,{class:"send","split-button":"",disabled:!s.config.url||s.loading,onClick:e[5]||(e[5]=d=>s.handlerRequest("default")),onCommand:s.operationCommand},{dropdown:o(()=>[i(Q,null,{default:o(()=>[i(f,{command:"showViewer"},{default:o(()=>[i(_,null,{default:o(()=>[i(m)]),_:1}),D("预览API")]),_:1}),s.closeOperation?O("",!0):(g(),A(f,{key:0,command:"batchRequest"},{default:o(()=>[i(w,{icon:"Play_One"}),D("执行"+F(n.batchReqNum)+"次",1)]),_:1})),!s.closeOperation&&n.apiDetail.id===-1?(g(),A(f,{key:1,command:"saveApi"},{default:o(()=>[i(_,null,{default:o(()=>[i(y)]),_:1}),D("新建API")]),_:1})):O("",!0),!s.closeOperation&&n.apiDetail.id!==-1?(g(),A(f,{key:2,command:"updateApi"},{default:o(()=>[i(_,null,{default:o(()=>[i(b)]),_:1}),D("更新API")]),_:1})):O("",!0),i(f,{command:"shareApi"},{default:o(()=>[I((g(),A(u,null,{default:o(()=>[i(_,null,{default:o(()=>[i(V)]),_:1}),D("分享API")]),_:1})),[[U,s.copyOptions]])]),_:1}),i(f,{command:"copyPath"},{default:o(()=>[I((g(),A(u,null,{default:o(()=>[i(_,null,{default:o(()=>[i(k)]),_:1}),D("复制路径")]),_:1})),[[U,s.copyOptions]])]),_:1})]),_:1})]),default:o(()=>[D("执行 ")]),_:1},8,["disabled","onCommand"])]),i(G,{modelValue:a.requestActive,"onUpdate:modelValue":e[7]||(e[7]=d=>a.requestActive=d),class:"request-config"},{default:o(()=>[i(R,{label:"Api Detail",name:"Detail"},{default:o(()=>[i(H)]),_:1}),i(R,{label:"Header",name:"Header"},{default:o(()=>[i(j,{modelValue:s.header,"onUpdate:modelValue":e[6]||(e[6]=d=>s.header=d)},null,8,["modelValue"])]),_:1}),i(R,{label:"Query",name:"Query"},{default:o(()=>[i(N)]),_:1}),i(R,{label:"Body",name:"Body"},{default:o(()=>[i(z,{onUpdateApi:s.updateApi,onUploadFileChange:s.uploadFileChange},null,8,["onUpdateApi","onUploadFileChange"])]),_:1})]),_:1},8,["modelValue"])]),i(M,{modelValue:a.showViewer,"onUpdate:modelValue":e[8]||(e[8]=d=>a.showViewer=d)},null,8,["modelValue"])],64)}const xe=pe(me,[["render",_e],["__scopeId","data-v-31e74240"]]);export{xe as R};
