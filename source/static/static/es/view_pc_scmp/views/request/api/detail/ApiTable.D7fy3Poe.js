import{g as b,a as R,t as k,b as x}from"../../../../../resources/global/global.util.BDToHPEB.js";import{s as v}from"../../../../../resources/util/snowflake.util.BS7FKuq4.js";import{e as s,r as c,f as y,aa as _,ab as O,c as E,w as L,o as M}from"../../../../../.store.ssRjOe-B.js";import{M as I}from"../../../../../resources/util/map.DsJxN4sz.js";import{_ as A}from"../../../../../components/address/S3Address.Dp8cFelg.js";function V(e){return typeof e=="function"||Object.prototype.toString.call(e)==="[object Object]"&&!O(e)}const z={name:"ApiTable",components:{},setup(){return{}},emits:["update:modelValue","fileChange"],props:{modelValue:{type:Array},settingValue:{type:Boolean,default:!1},settingCheck:{type:Boolean,default:!1},headerCellRenderer:{type:Function},typeOptions:{type:Array,default:()=>{}}},data(){return{waitResizeDebounce:void 0,editing:[],dataMap:new I,expandedRowKeys:[],lastWith:void 0,files:{},operationColumn:{key:"operation",width:60,align:"center",cellRenderer:this.operationCellRenderer,headerCellRenderer:this.operationHeaderCellRenderer},checkColumn:{key:"selection",dataKey:"check",width:50,align:"center",cellRenderer:this.selectionCellRenderer,headerCellRenderer:this.selectionHeaderCellRenderer},keyColumn:{key:"key",dataKey:"key",title:"参数名",width:120,cellRenderer:this.cellRenderer},typeColumn:{key:"type",dataKey:"type",title:"参数类型",width:90,cellRenderer:this.typeCellRenderer},valueColumn:{key:"value",dataKey:"value",title:"参数值",width:160,cellRenderer:this.cellRenderer},descColumn:{key:"desc",dataKey:"desc",title:"描述",width:300,cellRenderer:this.cellRenderer},placeholder:{key:"请输入参数名",value:"请输入参数值",desc:"请输入描述"},typeOptions_:["String","Number","Boolean","File","Object","List"]}},computed:{columns_(){const e=[];return e.push(this.operationColumn),this.settingCheck&&e.push(this.checkColumn),e.push(this.keyColumn),e.push(this.typeColumn),this.settingValue&&e.push(this.valueColumn),e.push(this.descColumn),e},columnsWidth(){return this.columns_.map(e=>e.width).reduce((e,n)=>e+n,0)},typeSelectOptions(){return(this.typeOptions?this.typeOptions:this.typeOptions_).map(n=>s(c("el-option"),{key:n,value:n,label:n},null))},dataList:{get(){return this.modelValue},set(e){this.$emit("update:modelValue",e)}}},watch:{},created(){this.waitResizeDebounce=R(this.waitResize,.1),k(this.dataList).forEach(e=>this.dataMap.put(e.id,e))},mounted(){const n=this.$refs.tableV2.$el.querySelector(".el-table-v2__body div div");let t={animation:150,handle:".drag-row-col",draggable:".api-table-row",onMove:this.sortableOnMove,onEnd:this.sortableOnEnd};new _(n,t)},methods:{sortableOnMove(e,n){const t=e.dragged;t.removeAttribute("targetRowKey");const i=b(n.target,h=>{var o;return(o=h.className)==null?void 0:o.includes("api-table-row")});if(!i)return!1;const l=t.getAttribute("rowKey"),a=i.getAttribute("rowKey");if(!a)return!1;const f=this.dataMap.get(l),d=this.dataMap.get(a);if(f.parentId!==d.parentId)return!1;t.setAttribute("targetRowKey",a)},sortableOnEnd(e){if(e.oldIndex===e.newIndex)return;const{item:n}=e,t=n.getAttribute("rowKey"),i=n.getAttribute("targetRowKey");if(!t||!i)return;const l=this.getDataList(this.dataList,o=>t===o.id||i===o.id),a=this.dataMap.get(t),f=this.dataMap.get(i);let d=l.indexOf(a),h=l.indexOf(f);l.splice(h,0,l.splice(d,1)[0]),n.removeAttribute("targetRowKey")},getDataList(e=[],n){for(let t of e)if(n(t))return e;for(let t of e){if(!t.children)continue;const i=this.getDataList(t.children,n);if(i)return i}},onResize({width:e,height:n}){!e||e===this.lastWith||this.waitResizeDebounce(this.lastWith=e,n)},waitResize(e,n){const t=e/this.columnsWidth;this.columns_.forEach(i=>i.width=i.width*t)},onCheckChange(e,n){e.forEach(t=>{t.check=n,t.children&&t.children.length&&this.onCheckChange(t.children,n)})},selectionHeaderCellRenderer(){const e=l=>this.onCheckChange(this.dataList,l),n=this.dataList.length<=0,t=!n&&this.dataList.every(l=>l.check),i=this.dataList.some(l=>l.check);return s(c("ElCheckbox"),{disabled:n,onChange:e,modelValue:t,indeterminate:i&&!t},null)},selectionCellRenderer({rowData:e}){const n=t=>this.onCheckChange([e],t);return s(c("ElCheckbox"),{onChange:n,modelValue:e.check,indeterminate:!1},null)},expandedRowsChange(e){this.expandedRowKeys=e},cellRenderer({rowData:e,column:{key:n,dataKey:t,width:i},rowIndex:l}){if(t==="value"){if(e.type==="List")return s("span",null,[y("[]")]);if(e.type==="Object")return s("span",null,[y("{}")]);if(e.type==="File"){const r=(g,p)=>this.uploadFile(g,p,e,t),u=(g,p)=>this.removeFile(g,p,e,t);return s("div",{class:"value-upload-file"},[s(c("el-popover"),{width:i,teleported:!1},{reference:()=>s(c("el-upload"),{class:"upload-file",multiple:!0,"file-list":this.files[e.id],"show-file-list":!1,"auto-upload":!1,onChange:r},{trigger:()=>{let g;return s(c("el-text"),{truncated:!0,class:"file-names empty-text",placeholder:"请选择上传的文件"},V(g=(this.files[e.id]||[]).map(p=>p.name).join(","))?g:{default:()=>[g]})}}),default:()=>s(c("el-upload"),{className:"upload-file-list",multiple:!0,"file-list":this.files[e.id],"auto-upload":!1,onRemove:u},{trigger:()=>s("div",{style:"display:none"},null)})})])}}const a=this.dataMap.get(e.parentId);if((a==null?void 0:a.type)==="List"&&t==="key"){const r=a.children.getIndex(u=>u.id===e.id);return s("span",null,[y("["),r,y("]")])}this.editing[l]||(this.editing[l]={});const f=()=>this.editing[l][t]=!1,d=r=>e[t]=r,h=r=>{var u;return(u=r==null?void 0:r.focus)==null?void 0:u.call(r)},o=this.placeholder[t];return t==="desc"?s("div",{class:"span-text-wrapper"},[s(c("el-popover"),{trigger:"click",width:i,teleported:!1},{reference:()=>s(c("el-text"),{truncated:!0,class:"span-text empty-text",placeholder:o},{default:()=>[e[t]]}),default:()=>s(c("el-input"),{ref:h,clearable:!0,type:"textarea",resize:"none",rows:3,modelValue:e[t],placeholder:o,onBlur:f,onInput:d},null)})]):this.editing[l][t]?s(c("el-input"),{ref:h,clearable:!0,modelValue:e[t],onBlur:f,onInput:d,placeholder:o},null):s("div",{class:"span-text-wrapper",onClick:()=>this.editing[l][t]=!0},[s(c("el-text"),{truncated:!0,class:"span-text empty-text",placeholder:o},{default:()=>[e[t]]})])},typeCellRenderer({rowData:e,column:{dataKey:n},rowIndex:t}){this.editing[t]||(this.editing[t]={});const i=d=>{if(e.type=d,d!=="List"&&d!=="Object"){e.children=void 0,this.expandedRowKeys.removeIf(m=>m.id===e.id);return}const h=e.id;this.expandedRowKeys.push(h),this.dataMap.put(h,e);const o={parentId:h,id:this.indexNum(),key:"",type:"String",value:"",desc:"",check:this.settingCheck};e.children=[o]},l=d=>{var h;return(h=d==null?void 0:d.focus)==null?void 0:h.call(d)},a=()=>this.editing[t][n]=!0,f=()=>this.editing[t][n]=!1;return this.editing[t][n]?s(c("el-select"),{ref:l,modelValue:e.type,onBlur:f,onChange:i},{default:()=>[this.typeSelectOptions]}):s("div",{class:"span-text-wrapper",onClick:a},[s(c("el-text"),{truncated:!0,class:"span-text"},{default:()=>[e.type]})])},operationHeaderCellRenderer(){const e=()=>{const i={id:this.indexNum(),key:"",type:"String",value:"",desc:"",check:this.settingCheck};this.dataList.insert(this.dataList.length,i),this.dataMap.put(i.id,i)},n=s(c("el-button"),{icon:"Plus",size:"small",circle:!0,onClick:e},null),t=this.headerCellRenderer(this.dataList);return s("div",{class:"operation"},[[t,n]])},operationCellRenderer({rowData:e,column:n,rowIndex:t,columnIndex:i}){const l=()=>{this.editing[t]={};const o=this.dataMap.get(e.parentId);if(!o){const u=this.dataList.delete(t);return this.dataMap.remove(u.id)}if(!o.children.remove(e))throw new Error("删除失败");const r=k([e]).map(u=>u.id);r.forEach(u=>this.dataMap.remove(u)),this.expandedRowKeys.removeIf(u=>r.includes(u))},a=s(c("el-button"),{icon:"Delete",size:"small",circle:!0,onClick:l},null),f=()=>{var m;const o=e.id;if(this.dataMap.put(o,e),!((m=e.children)!=null&&m.length)||e.type==="Object"){e.children||(e.children=[]);const r={parentId:o,id:this.indexNum(),check:this.settingCheck,key:"",type:"String",value:"",desc:""};e.children.push(r)}else{const r=e.children.endElement();let u=JSON.parse(`{"${r.parentId}":"${r.parentId}"}`);const g=x(r,p=>{if(p instanceof Array)return;p.value=void 0;let C=u[p.parentId];C||(C=u[p.parentId]=this.indexNum()),p.parentId=C,p.id=u[p.id],p.id||(p.id=this.indexNum()),this.dataMap.put(p.id,p)});e.children.push(g)}},d=s(c("el-button"),{icon:"Plus",size:"small",circle:!0,onClick:f},null),h=e.type==="List"||e.type==="Object"?[a,d]:a;return s("div",{class:"operation drag-row-col"},[h])},indexNum(){return v().toString()},uploadFile(e,n,t,i){this.files[t.id]=n,t[i]=n.map(l=>l.name),this.$emit("fileChange",e,"append")},removeFile(e,n,t,i){this.files[t.id]=n,t[i].remove(e.name),this.$emit("fileChange",e,"remove")}}};function B(e,n,t,i,l,a){const f=c("el-table-v2"),d=c("el-auto-resizer");return M(),E(d,{class:"document-table",onResize:a.onResize},{default:L(({height:h,width:o})=>[s(f,{ref:"tableV2","row-class":"api-table-row",width:o,height:h,fixed:"","expand-column-key":"key","expanded-row-keys":l.expandedRowKeys,onExpandedRowsChange:a.expandedRowsChange,columns:this.columns_,data:a.dataList},null,8,["width","height","expanded-row-keys","onExpandedRowsChange","columns","data"])]),_:1},8,["onResize"])}const K=A(z,[["render",B]]);export{K as A};
