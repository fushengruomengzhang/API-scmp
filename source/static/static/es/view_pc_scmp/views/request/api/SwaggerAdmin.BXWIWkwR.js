import{s as f}from"../../../../resources/util/snowflake.util.CMOmz3k-.js";import{r as B}from"../../../../stores/request.server.Jl9Oinz8.js";import{j as D,k as F,m as q}from"../util/request.utils.C-Y0rqBy.js";import{u as j}from"../../../../resources/global/global.util.CdGU-cda.js";import{_ as N}from"../../../../components/address/S3Address.C-l0MtE3.js";import{s as V}from"../../../../pinia.C4zkjZtA.js";import{a as O,l as v,e as y,w,F as $,r as g,o as P,f as x,c as L,t as T}from"../../../../vue.B9VI7CMM.js";const M={name:"SwaggerAdmin",components:{},setup(){const{reset:t,setOtherConfigCache:e,getOtherConfigCache:r}=B(),{isSwagger:o,selectEntityId:s,entityMap:n}=V(B());return{reset:t,setOtherConfigCache:e,getOtherConfigCache:r,isSwagger:o,selectEntityId:s,entityMap:n}},emits:[],props:{},data(){return{swaggerPath:void 0,swaggerData:[],treeProps:{children:"children",isLeaf:t=>t.type==="api",label:"name"},typeMapping:{integer:"Number",string:"String",boolean:"Boolean",object:"Object",array:"List"}}},computed:{},watch:{},created(){this.reset(),this.isSwagger=!0},mounted(){},methods:{resolveType(t){return this.typeMapping[t]||t},resolveRef(t,e){return e.replace(/^#\//,"").split("/").reduce((o,s)=>o&&o[s],t)},buildBodyProperties(t,e,r=[]){var s;let o=[];for(const n in e){const i=e[n],c=(i.format||((s=i.items)==null?void 0:s.format))==="binary"?"File":this.resolveType(i.type)||"Object";if(r.includes(i.$ref))continue;i.$ref&&r.push(i.$ref);let d;if(i.$ref){const a=this.resolveRef(t,i.$ref);d=this.buildBodyProperties(t,a.properties,r)}o.push({id:f(),key:n,type:c,value:void 0,children:d,desc:i.description,check:!0})}return o},buildBody(t,e){var n,i,c,d;let r=this.resolveType(e.type);e.$ref&&(r="Object"),((i=(n=e.properties)==null?void 0:n.file)==null?void 0:i.format)==="binary"&&(r="File");let o,s="";if(r==="File"&&e.required&&(s=e.required[0]),r==="List"||r==="Object"||r==="File"){const a=e.$ref||((c=e.items)==null?void 0:c.$ref),h=e.items||e.additionalProperties;if(h)o=this.buildBody(t,h);else if(e.properties)o=this.buildBodyProperties(t,e.properties);else if(a){const p=this.resolveRef(t,a);o=this.buildBodyProperties(t,p.properties);const m=this.resolveType(p.type);r==="List"&&(o=[{id:f(),key:s,type:m,value:void 0,desc:p.description,check:!0,children:o}])}}if(!o&&!["File"].includes(r)){let a=r;(d=e.items)!=null&&d.type&&(a=this.resolveType(e.items.type)),o=[{id:f(),key:s,type:a,value:q[a],check:!0}]}return[{id:f(),key:s,type:r,value:void 0,desc:void 0,check:!0,children:o}]},apiNodeClick(t,e,r,o){if(t.type==="folder")return;if(this.entityMap.contains(t.id))return this.entityMap.get(t.id);const{name:s,id:n,type:i,apiDocs:c,method:d,url:a,urlDetail:{parameters:h,requestBody:p,summary:m},apiDocs:{servers:[b]}}=t,l={prefix:void 0,contextPath:void 0,method:d,url:a,bodyType:void 0,domain:b.url,header:[],query:[],queryBody:void 0,bodyDocument:[],formBodyDocument:[],urlBodyDocument:[],responseDocument:[]},k={name:s,id:n,type:i,desc:m,config:l};if(h&&(l.query=h.map(u=>{const _=this.resolveType(u.schema.type);return{id:f(),key:u.name,type:_,value:void 0,desc:u.description,check:u.required}})),p)for(const u in p.content){l.bodyType=u;const _=this.buildBody(c,p.content[u].schema);if(u==="application/json"){l.bodyDocument=_;let C=D(l.bodyDocument);const S=Object.keys(C);S.length===1&&S[0]===""&&(C=C[""]),l.queryBody=F(C)}else u==="multipart/form-data"?l.formBodyDocument=_[0].children:l.urlBodyDocument=_}this.entityMap.put(k.id,k),this.selectEntityId=k.id},fetchSwaggerPath(t,e){this.getOtherConfigCache("Swagger_Config_Path").then(r=>{if(!(r!=null&&r.value))return e([]);t=t.toLowerCase(),e(r.value.filter(o=>o&&o.toLowerCase().includes(t)).map(o=>({value:o})))})},loadSwaggerResources(){if(!this.swaggerPath)return this.$message({type:"warning",showClose:!0,message:"请输入Swagger地址",center:!0});new Promise(t=>this.loadSwagger({level:0},t)).then(t=>{t.length<=0||(this.swaggerData=t,this.getOtherConfigCache("Swagger_Config_Path").then(e=>{const r=(e==null?void 0:e.value)||[];r.includes(this.swaggerPath)||r.push(this.swaggerPath),this.setOtherConfigCache("Swagger_Config_Path",r)}))})},loadSwagger(t,e){if(!this.swaggerPath)return e([]);t.level===0?fetch(j(this.swaggerPath,"swagger-resources")).then(r=>r.json().then(o=>e(o.map(s=>({...s,id:f(),type:"folder"}))))).catch(r=>this.$message({type:"warning",showClose:!0,message:"请输入正确的Swagger地址",center:!0})):t.data.children?e(t.data.children):fetch(j(this.swaggerPath,t.data.url)).then(r=>r.json().then(o=>e(this.analysisApiDocs(o))))},analysisApiDocs(t){return Object.entries(t.paths).reduce((e,[r,o])=>(Object.entries(o).forEach(([s,n])=>{n.tags.forEach(i=>{const c={id:f(),type:"api",name:n.summary,method:s.toUpperCase(),url:r,tag:i,urlDetail:n,apiDocs:t},d=e.find(a=>a.name===i);d?d.children.push(c):e.push({id:f(),type:"folder",name:i,children:[c]})})}),e),[])}}},R={class:"swagger-config"},E={class:"node-item"},A=["data-text"],I={class:"tree-node-text"};function J(t,e,r,o,s,n){const i=g("el-autocomplete"),c=g("el-button"),d=g("Folder"),a=g("el-icon"),h=g("el-text"),p=g("s3-tree"),m=g("s3-scroll");return P(),O($,null,[v("div",R,[y(i,{modelValue:s.swaggerPath,"onUpdate:modelValue":e[0]||(e[0]=b=>s.swaggerPath=b),"fetch-suggestions":n.fetchSwaggerPath,clearable:"",placeholder:"请输入swagger地址"},null,8,["modelValue","fetch-suggestions"]),y(c,{class:"load-button",onClick:n.loadSwaggerResources},{default:w(()=>[x("加载")]),_:1},8,["onClick"])]),y(m,{class:"swagger-api-tree"},{default:w(()=>[y(p,{class:"tree-detail","node-key":"id","highlight-current":"",data:s.swaggerData,props:s.treeProps,lazy:"",load:n.loadSwagger,onNodeClick:n.apiNodeClick},{default:w(({node:b,data:l})=>[v("div",E,[l.type!=="api"?(P(),L(a,{key:0,class:"isFolder"},{default:w(()=>[y(d)]),_:1})):(P(),O("span",{key:1,class:"api-method","data-text":l.method},T(l.method),9,A)),v("div",I,[y(h,{class:"tree-node-text-wrapper",truncated:""},{default:w(()=>[x(T(l.name),1)]),_:2},1024)])])]),_:1},8,["data","props","load","onNodeClick"])]),_:1})],64)}const X=N(M,[["render",J],["__scopeId","data-v-d65b66a9"]]);export{X as S};
