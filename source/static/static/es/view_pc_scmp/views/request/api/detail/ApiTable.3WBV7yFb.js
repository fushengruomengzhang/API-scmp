import{g as R,d as x,t as k,b as v}from"../../../../../resources/global/global.util.CdGU-cda.js";import{s as _}from"../../../../../resources/util/snowflake.util.CMOmz3k-.js";import{S as E}from"../../../../../sortablejs.C83syoBY.js";import{M as O}from"../../../../../resources/util/map.DsJxN4sz.js";import{e as l,r as a,f as y,a7 as L,c as M,w as I,o as A}from"../../../../../vue.B9VI7CMM.js";import{_ as V}from"../../../../../components/address/S3Address.C-l0MtE3.js";function b(e){return typeof e=="function"||Object.prototype.toString.call(e)==="[object Object]"&&!L(e)}const z={name:"ApiTable",components:{},setup(){return{}},emits:["update:modelValue","fileChange"],props:{modelValue:{type:Array},settingValue:{type:Boolean,default:!1},settingCheck:{type:Boolean,default:!1},headerCellRenderer:{type:Function},typeOptions:{type:Array,default:()=>{}}},data(){return{waitResizeDebounce:void 0,editing:[],dataMap:new O,expandedRowKeys:[],lastWith:void 0,files:{},operationColumn:{key:"operation",width:60,align:"center",cellRenderer:this.operationCellRenderer,headerCellRenderer:this.operationHeaderCellRenderer},checkColumn:{key:"selection",dataKey:"check",width:50,align:"center",cellRenderer:this.selectionCellRenderer,headerCellRenderer:this.selectionHeaderCellRenderer},keyColumn:{key:"key",dataKey:"key",title:"参数名",width:120,cellRenderer:this.cellRenderer},typeColumn:{key:"type",dataKey:"type",title:"参数类型",width:90,cellRenderer:this.typeCellRenderer},valueColumn:{key:"value",dataKey:"value",title:"参数值",width:160,cellRenderer:this.cellRenderer},descColumn:{key:"desc",dataKey:"desc",title:"描述",width:300,cellRenderer:this.cellRenderer},placeholder:{key:"请输入参数名",value:"请输入参数值",desc:"请输入描述"},typeOptions_:["String","Number","Boolean","File","Object","List"]}},computed:{columns_(){const e=[];return e.push(this.operationColumn),this.settingCheck&&e.push(this.checkColumn),e.push(this.keyColumn),e.push(this.typeColumn),this.settingValue&&e.push(this.valueColumn),e.push(this.descColumn),e},columnsWidth(){return this.columns_.map(e=>e.width).reduce((e,n)=>e+n,0)},typeSelectOptions(){return this.typeOptions?this.typeOptions:this.typeOptions_},dataList:{get(){return this.modelValue},set(e){this.$emit("update:modelValue",e)}}},watch:{},created(){this.waitResizeDebounce=x(this.waitResize,.1),k(this.dataList).forEach(e=>this.dataMap.put(e.id,e))},mounted(){const n=this.$refs.tableV2.$el.querySelector(".el-table-v2__body div div");let t={animation:150,handle:".drag-row-col",draggable:".api-table-row",onMove:this.sortableOnMove,onEnd:this.sortableOnEnd};new E(n,t)},methods:{sortableOnMove(e,n){const t=e.dragged;t.removeAttribute("targetRowKey");const i=R(n.target,f=>{var d;return(d=f.className)==null?void 0:d.includes("api-table-row")});if(!i)return!1;const s=t.getAttribute("rowKey"),o=i.getAttribute("rowKey");if(!o)return!1;const c=this.dataMap.get(s),u=this.dataMap.get(o);if(c.parentId!==u.parentId)return!1;t.setAttribute("targetRowKey",o)},sortableOnEnd(e){if(e.oldIndex===e.newIndex)return;const{item:n}=e,t=n.getAttribute("rowKey"),i=n.getAttribute("targetRowKey");if(!t||!i)return;const s=this.getDataList(this.dataList,d=>t===d.id||i===d.id),o=this.dataMap.get(t),c=this.dataMap.get(i);let u=s.indexOf(o),f=s.indexOf(c);s.splice(f,0,s.splice(u,1)[0]),n.removeAttribute("targetRowKey")},getDataList(e=[],n){for(let t of e)if(n(t))return e;for(let t of e){if(!t.children)continue;const i=this.getDataList(t.children,n);if(i)return i}},onResize({width:e,height:n}){!e||e===this.lastWith||this.waitResizeDebounce(this.lastWith=e,n)},waitResize(e,n){const t=e/this.columnsWidth;this.columns_.forEach(i=>i.width=i.width*t)},onCheckChange(e,n){e.forEach(t=>{t.check=n,t.children&&t.children.length&&this.onCheckChange(t.children,n)})},selectionHeaderCellRenderer(){const e=s=>this.onCheckChange(this.dataList,s),n=this.dataList.length<=0,t=!n&&this.dataList.every(s=>s.check),i=this.dataList.some(s=>s.check);return l(a("ElCheckbox"),{disabled:n,onChange:e,modelValue:t,indeterminate:i&&!t},null)},selectionCellRenderer({rowData:e}){const n=t=>this.onCheckChange([e],t);return l(a("ElCheckbox"),{onChange:n,modelValue:e.check,indeterminate:!1},null)},expandedRowsChange(e){this.expandedRowKeys=e},cellRenderer({rowData:e,column:{key:n,dataKey:t,width:i},rowIndex:s}){if(t==="value"){if(e.type==="List")return l("span",null,[y("[]")]);if(e.type==="Object")return l("span",null,[y("{}")]);if(e.type==="File"){const r=(g,p)=>this.uploadFile(g,p,e,t),h=(g,p)=>this.removeFile(g,p,e,t);return l("div",{class:"value-upload-file"},[l(a("el-popover"),{width:i,teleported:!1},{reference:()=>l(a("el-upload"),{class:"upload-file",multiple:!0,"file-list":this.files[e.id],"show-file-list":!1,"auto-upload":!1,onChange:r},{trigger:()=>{let g;return l(a("el-text"),{truncated:!0,class:"file-names empty-text",placeholder:"请选择上传的文件"},b(g=(this.files[e.id]||[]).map(p=>p.name).join(","))?g:{default:()=>[g]})}}),default:()=>l(a("el-upload"),{className:"upload-file-list",multiple:!0,"file-list":this.files[e.id],"auto-upload":!1,onRemove:h},{trigger:()=>l("div",{style:"display:none"},null)})})])}}const o=this.dataMap.get(e.parentId);if((o==null?void 0:o.type)==="List"&&t==="key"){const r=o.children.getIndex(h=>h.id===e.id);return l("span",null,[y("["),r,y("]")])}this.editing[s]||(this.editing[s]={});const c=()=>this.editing[s][t]=!1,u=r=>e[t]=r,f=r=>{var h;return(h=r==null?void 0:r.focus)==null?void 0:h.call(r)},d=this.placeholder[t];return t==="desc"?l("div",{class:"span-text-wrapper"},[l(a("el-popover"),{trigger:"click",width:i,teleported:!1},{reference:()=>l(a("el-text"),{truncated:!0,class:"span-text empty-text",placeholder:d},{default:()=>[e[t]]}),default:()=>l(a("el-input"),{ref:f,clearable:!0,type:"textarea",resize:"none",rows:3,modelValue:e[t],placeholder:d,onBlur:c,onInput:u},null)})]):this.editing[s][t]?l(a("el-input"),{ref:f,clearable:!0,modelValue:e[t],onBlur:c,onInput:u,placeholder:d},null):l("div",{class:"span-text-wrapper",onClick:()=>this.editing[s][t]=!0},[l(a("el-text"),{truncated:!0,class:"span-text empty-text",placeholder:d},{default:()=>[e[t]]})])},typeCellRenderer({rowData:e,column:{dataKey:n},rowIndex:t}){this.editing[t]||(this.editing[t]={});const i=c=>{if(e.type=c,c!=="List"&&c!=="Object"){e.children=void 0,this.expandedRowKeys.removeIf(d=>d.id===e.id);return}const u=e.id;this.expandedRowKeys.push(u),this.dataMap.put(u,e);const f={parentId:u,id:this.indexNum(),key:"",type:"String",value:"",desc:"",check:this.settingCheck};e.children=[f]},s=()=>this.editing[t][n]=!0,o=()=>this.editing[t][n]=!1;if(this.editing[t][n]){let c;return l(a("el-select"),{modelValue:e.type,onBlur:o,onChange:i},b(c=this.typeSelectOptions.map(u=>l(a("el-option"),{key:u,value:u,label:u},null)))?c:{default:()=>[c]})}return l("div",{class:"span-text-wrapper",onClick:s},[l(a("el-text"),{truncated:!0,class:"span-text"},{default:()=>[e.type]})])},operationHeaderCellRenderer(){const e=()=>{const i={id:this.indexNum(),key:"",type:"String",value:"",desc:"",check:this.settingCheck};this.dataList.insert(this.dataList.length,i),this.dataMap.put(i.id,i)},n=l(a("el-button"),{icon:"Plus",size:"small",circle:!0,onClick:e},null),t=this.headerCellRenderer(this.dataList);return l("div",{class:"operation"},[[t,n]])},operationCellRenderer({rowData:e,column:n,rowIndex:t,columnIndex:i}){const s=()=>{this.editing[t]={};const d=this.dataMap.get(e.parentId);if(!d){const h=this.dataList.delete(t);return this.dataMap.remove(h.id)}if(!d.children.remove(e))throw new Error("删除失败");const r=k([e]).map(h=>h.id);r.forEach(h=>this.dataMap.remove(h)),this.expandedRowKeys.removeIf(h=>r.includes(h))},o=l(a("el-button"),{icon:"Delete",size:"small",circle:!0,onClick:s},null),c=()=>{var m;const d=e.id;if(this.dataMap.put(d,e),!((m=e.children)!=null&&m.length)||e.type==="Object"){e.children||(e.children=[]);const r={parentId:d,id:this.indexNum(),check:this.settingCheck,key:"",type:"String",value:"",desc:""};e.children.push(r)}else{const r=e.children.endElement();let h=JSON.parse(`{"${r.parentId}":"${r.parentId}"}`);const g=v(r,p=>{if(p instanceof Array)return;p.value=void 0;let C=h[p.parentId];C||(C=h[p.parentId]=this.indexNum()),p.parentId=C,p.id=h[p.id],p.id||(p.id=this.indexNum()),this.dataMap.put(p.id,p)});e.children.push(g)}},u=l(a("el-button"),{icon:"Plus",size:"small",circle:!0,onClick:c},null),f=e.type==="List"||e.type==="Object"?[o,u]:o;return l("div",{class:"operation drag-row-col"},[f])},indexNum(){return _().toString()},uploadFile(e,n,t,i){this.files[t.id]=n,t[i]=n.map(s=>s.name),this.$emit("fileChange",e,"append")},removeFile(e,n,t,i){this.files[t.id]=n,t[i].remove(e.name),this.$emit("fileChange",e,"remove")}}};function B(e,n,t,i,s,o){const c=a("el-table-v2"),u=a("el-auto-resizer");return A(),M(u,{class:"document-table",onResize:o.onResize},{default:I(({height:f,width:d})=>[l(c,{ref:"tableV2","row-class":"api-table-row",width:d,height:f,fixed:"","expand-column-key":"key","expanded-row-keys":s.expandedRowKeys,onExpandedRowsChange:o.expandedRowsChange,columns:this.columns_,data:o.dataList},null,8,["width","height","expanded-row-keys","onExpandedRowsChange","columns","data"])]),_:1},8,["onResize"])}const $=V(z,[["render",B]]);export{$ as A};
