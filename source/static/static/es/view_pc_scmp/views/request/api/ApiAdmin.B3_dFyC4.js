import{l as W,e as b,u as P,s as G,a as H}from"../../../../resources/global/global.util.CrvsVFo3.js";import{E as Q}from"./detail/EditApi.DGjZitES.js";import{r as T}from"../../../../stores/request.server.OPoUfqQ8.js";import{a as I}from"../util/request.utils.Cc8QJvHY.js";import X from"../doc/ApiDocEditor.ByKek-En.js";import{s as Y}from"../../../../resources/util/snowflake.util.C4QYlgiq.js";import{_ as Z}from"../../../../components/address/S3Address.BvGSUWFm.js";import{s as $}from"../../../../pinia.DPawhP_y.js";import{a as D,l as y,e as s,w as a,F as E,r as d,q as ee,o as _,c as k,j as N,f as p,t as v,d as M}from"../../../../vue.CpRb0aFL.js";const te={name:"ApiAdmin",components:{ApiDocEditor:X,EditApi:Q},setup(){const{cacheId:e,delCacheId:t,getAllCacheId:i,defaultApiDetail:l,getOtherConfigCache:o}=T(),{selectEntityId:n,selectParentId:r,entityMap:f,refreshApiTree:u,domainOptions:w,apiDocDetail:C,batchReqNum:A}=$(T());return{defaultApiDetail:l,selectEntityId:n,selectParentId:r,entityMap:f,refreshApiTree:u,domainOptions:w,batchReqNum:A,cacheId:e,delCacheId:t,getAllCacheId:i,apiDocDetail:C,getOtherConfigCache:o}},emits:[],props:{},data(){return{showTooltip:!1,tooltipRef:void 0,tooltipData:{},searchText:void 0,edit:{entity:{},visible:!1},apiData:[],treeProps:{children:"children",isLeaf:e=>e.type==="api",label:"name"},checkApi:!1,checkApiList:[],sharePath:void 0,showAddApiDoc:!1,showTooltipDebounce:H((e,t)=>{if(!e)return this.showTooltip=!1;this.tooltipRef=e,this.tooltipData=t,this.showTooltip=!0},.3),copyOptions:{groupId:Y("copy"),getElement:e=>e.parentElement,options:{text:e=>this.sharePath},onSuccess:e=>this.$message({type:"success",showClose:!0,message:"路径已生成",center:!0})}}},computed:{batchShareDisabled(){return!this.checkApi||!this.checkApiList.length}},watch:{searchText(e){this.findByName(e)},checkApi(e,t){e||this.checkApiList.forEach(i=>this.$refs.apiTree.setChecked(i,!1))}},created(){this.findEnvConfig(),this.useAllCache(),this.initBatchReqNum(),this.refreshApiTree=this.commitCallback},mounted(){},beforeUnmount(){},methods:{apiTreeNodeOnMouseover(e,t){this.showTooltipDebounce(e.currentTarget.parentElement,t)},onApiTreeCheck(e,{checkedKeys:t}){this.checkApiList=t},handleCommand(e){if(this.$route.name.endsWith(I)||G(.05).then(t=>this.$router.push({name:this.$route.meta.name+I})),e==="shareOpenApi")return this.shareOpenApi();if(e==="updateCheckApi")return this.updateCheckApi();if(e==="shareCheckApi")return this.shareCheckApi();if(e==="addApiDoc")return this.addApiDoc()},updateCheckApi(){return this.checkApi&&(this.checkApiList=[],this.$refs.apiTree.setCheckedKeys([],!1)),this.checkApi=!this.checkApi},addApiDoc(){const e=this.checkApiList,t=b(e.sort().join(","));this.findOne("tb_api_docs.find",{flag:t}).then(i=>{this.apiDocDetail=i.data.id?i.data:{parent_id:0,type:"doc",api_ids:e,flag:t}}).finally(()=>this.showAddApiDoc=!0)},findEnvConfig(){var i;if((i=this.domainOptions)!=null&&i.length)return;const e=new Promise(l=>this.findOne("tb_config.findAll",{key:"requestEnvConfig"}).then(o=>{o.data.value&&l(o.data.value)})),t=new Promise(l=>this.getOtherConfigCache("Local_Env_Config").then(o=>l(o?o.value:[])));Promise.all([e,t]).then(([l,o])=>{o.forEach(({name:n,domain:r})=>this.domainOptions.push({name:n,domain:r,localEnv:!0})),l.forEach(({name:n,domain:r})=>this.domainOptions.push({name:n,domain:r,localEnv:!1}))})},shareOpenApi(){const{origin:e,pathname:t}=window.location,i=b(this.entityMap.keys().sort().join(","));this.sharePath=P(e,t)+`#/shareRequest?id=${i}`},shareCheckApi(){const{origin:e,pathname:t}=window.location,i=b(this.checkApiList.sort().join(","));this.sharePath=P(e,t)+`#/shareRequest?id=${i}`},apiNodeAllowDrop(e,t,i){return t.data.type!=="api"&&i==="inner"},apiNodeDrop(e,t,i){this.$confirm(`是否拖拽 [${e.data.name}] 到 [${t.data.name}] ?`,"提示",{confirmButtonText:"是",cancelButtonText:"否",type:"warning"}).then(l=>{const o=t.data.id||0,n=e.data.id;this.update("tb_request_api.update",{id:n,parent_id:o}).then(r=>{this.entityMap.contains(n)&&(this.entityMap.get(n).parent_id=o)})}).catch(l=>{this.$refs.apiTree.reloadNode(e.data.parent_id,t.data.id)})},showRightMenu(e,t,i){var l,o,n,r;if(t.config=t.config?t.config:{},!t.config.contextPath){const f=(l=i.parent)==null?void 0:l.data;f&&(t.config.contextPath=(o=f.config)==null?void 0:o.contextPath)}if(!t.config.prefix){const f=(n=i.parent)==null?void 0:n.data;f&&(t.config.prefix=(r=f.config)==null?void 0:r.prefix)}this.$refs.rightMenu.click(e,{node:i,entity:t})},showEdit(e){e.config=e.config?e.config:{},this.edit={entity:e,visible:!0}},newChild(e,t){const i={prefix:e.config.prefix,contextPath:e.config.contextPath},l={type:t,parent_id:e.id,config:i};this.edit={entity:l,visible:!0}},refresh(e){this.$refs.apiTree.reloadNode(e)},commitCallback(e){const t=this.$refs.apiTree.getNode(e.id),i=t==null?void 0:t.parent;e.parent_id!==(i==null?void 0:i.data.id)&&(i==null||i.childNodes.removeIf(l=>l.data.id===e.id)),this.$refs.apiTree.reloadNode(e.parent_id,e.id)},findByName(e){const t=e?{search:e}:{parentId:0};this.findAll("tb_request_api.find",t).then(i=>this.apiData=W(i.data))},delFolder(e,t){this.$confirm(`确定要删除[${t.name}]吗?`,"警告",{type:"warning"}).then(i=>{this.delete("tb_request_api.delete",{id:t.id}).then(l=>{var o,n;return(n=(o=e.parent)==null?void 0:o.childNodes)==null?void 0:n.removeIf(r=>r.data.id===t.id)})}).catch(i=>{})},findByParentId(e,t){this.findAll("tb_request_api.find",{parentId:e.data.id||0}).then(i=>t(i.data))},apiNodeClick(e,t,i,l){this.$refs.rightMenu.close(),this.selectParentId=e.type!=="api"?e.id:t.parent.data.id,e.type==="api"&&(this.entityMap.contains(-1)&&this.entityMap.remove(-1),this.entityMap.contains(e.id)||this.entityMap.put(e.id,e),this.selectEntityId=e.id,this.cacheId(e.id))},useAllCache(){this.getAllCacheId().then(e=>{if(!e||!e.length)return Promise.resolve();e.sort((i,l)=>i.cTime-l.cTime);const t=e.map(i=>i.id);return this.findAll("tb_request_api.find",{ids:t}).then(i=>Promise.resolve({data:i.data,ids:t}))}).then(e=>{if(!e)return this.entityMap.put(-1,this.defaultApiDetail);if(!e.data.length)return e.ids.forEach(this.delCacheId),this.entityMap.put(-1,this.defaultApiDetail);this.getOtherConfigCache("RequestApi_Select_Flag").then(t=>{this.selectEntityId=t!=null&&t.value?t.value:e.data[0].id}),e.data.sort((t,i)=>e.ids.indexOf(t.id)-e.ids.indexOf(i.id)),e.data.forEach(t=>this.entityMap.put(t.id,t)),e.ids.filter(t=>!this.entityMap.contains(t)).forEach(this.delCacheId)})},initBatchReqNum(){this.getOtherConfigCache("Batch_Req_Num").then(e=>{e!=null&&e.value&&(this.batchReqNum=e.value)})}}},ie={class:"operation"},oe=["onContextmenu","onMouseenter"],ne=["data-text"],se={class:"tree-node-text"},ae={style:{"white-space":"break-spaces"}};function le(e,t,i,l,o,n){const r=d("el-input"),f=d("Plus"),u=d("el-icon"),w=d("Share"),C=d("el-text"),A=d("el-dropdown-item"),O=d("Close"),q=d("Check"),R=d("Edit"),B=d("el-dropdown-menu"),V=d("el-dropdown"),L=d("Folder"),S=d("s3-tree"),F=d("s3-scroll"),j=d("el-tooltip"),U=d("edit-api"),g=d("el-link"),z=d("s3-right-menu"),J=d("api-doc-editor"),K=d("el-drawer"),x=ee("copy");return _(),D(E,null,[y("div",ie,[s(r,{class:"search",modelValue:o.searchText,"onUpdate:modelValue":t[0]||(t[0]=h=>o.searchText=h),placeholder:"搜索(名称或者路径)",clearable:""},null,8,["modelValue"]),s(V,{class:"operation-dropdown","split-button":"",type:"primary",onCommand:n.handleCommand,onClick:t[1]||(t[1]=h=>o.edit={entity:{type:"folder",config:{}},visible:!0})},{dropdown:a(()=>[s(B,null,{default:a(()=>[s(A,{command:"shareOpenApi"},{default:a(()=>[N((_(),k(C,null,{default:a(()=>[s(u,null,{default:a(()=>[s(w)]),_:1}),p("分享已打开的API")]),_:1})),[[x,o.copyOptions]])]),_:1}),o.checkApi?(_(),k(A,{key:0,command:"updateCheckApi",divided:""},{default:a(()=>[s(u,null,{default:a(()=>[s(O)]),_:1}),p("关闭API选择")]),_:1})):(_(),k(A,{key:1,command:"updateCheckApi",divided:""},{default:a(()=>[s(u,null,{default:a(()=>[s(q)]),_:1}),p("选择API")]),_:1})),s(A,{command:"addApiDoc",class:"addApiDoc",disabled:n.batchShareDisabled},{default:a(()=>[s(u,null,{default:a(()=>[s(R)]),_:1}),p("编辑API使用文档")]),_:1},8,["disabled"]),s(A,{command:"shareCheckApi",disabled:n.batchShareDisabled},{default:a(()=>[N((_(),k(C,null,{default:a(()=>[s(u,null,{default:a(()=>[s(w)]),_:1}),p("分享已选择的API")]),_:1})),[[x,o.copyOptions]])]),_:1},8,["disabled"])]),_:1})]),default:a(()=>[s(u,null,{default:a(()=>[s(f)]),_:1})]),_:1},8,["onCommand"])]),s(F,{class:"api-tree"},{default:a(()=>[s(S,{class:"tree-detail","node-key":"id","highlight-current":"",ref:"apiTree","show-checkbox":o.checkApi,"check-strictly":!0,draggable:!0,data:o.apiData,props:o.treeProps,lazy:"",load:n.findByParentId,"allow-drop":n.apiNodeAllowDrop,onCheck:n.onApiTreeCheck,onNodeDrop:n.apiNodeDrop,onNodeClick:n.apiNodeClick},{default:a(({node:h,data:c})=>[y("div",{class:"node-item",onContextmenu:m=>n.showRightMenu(m,c,h),onMouseenter:m=>n.apiTreeNodeOnMouseover(m,c),onMouseleave:t[2]||(t[2]=m=>o.showTooltipDebounce())},[c.type!=="api"?(_(),k(u,{key:0,class:"isFolder"},{default:a(()=>[s(L)]),_:1})):(_(),D("span",{key:1,class:"api-method","data-text":c.config.method},v(c.config.method),9,ne)),y("div",se,[s(C,{class:"tree-node-text-wrapper",truncated:""},{default:a(()=>[p(v(c.name),1)]),_:2},1024)])],40,oe)]),_:1},8,["show-checkbox","data","props","load","allow-drop","onCheck","onNodeDrop","onNodeClick"])]),_:1}),s(j,{visible:o.showTooltip,"virtual-ref":o.tooltipRef,placement:"right",effect:"customized"},{content:a(()=>[y("span",ae,v(o.tooltipData.desc||o.tooltipData.name),1)]),_:1},8,["visible","virtual-ref"]),s(U,{model:o.edit.entity,modelValue:o.edit.visible,"onUpdate:modelValue":t[3]||(t[3]=h=>o.edit.visible=h)},null,8,["model","modelValue"]),s(z,{ref:"rightMenu"},{default:a(({scope:{node:h,entity:c}})=>[c.type!=="api"?(_(),k(g,{key:0,icon:"Refresh",underline:!1,onClick:m=>n.refresh(c.id)},{default:a(()=>[p("刷新目录")]),_:2},1032,["onClick"])):M("",!0),s(g,{icon:"Edit",underline:!1,onClick:m=>n.showEdit(c)},{default:a(()=>[p("编辑"+v(c.type==="api"?"API":"目录"),1)]),_:2},1032,["onClick"]),s(g,{icon:"Delete",underline:!1,onClick:m=>n.delFolder(h,c)},{default:a(()=>[p("删除"+v(c.type==="api"?"API":"目录"),1)]),_:2},1032,["onClick"]),c.type!=="api"?(_(),D(E,{key:1},[s(g,{icon:"Plus",underline:!1,onClick:m=>n.newChild(c,"folder")},{default:a(()=>[p("新建子目录")]),_:2},1032,["onClick"]),s(g,{icon:"Plus",underline:!1,onClick:m=>n.newChild(c,"api")},{default:a(()=>[p("新建子API")]),_:2},1032,["onClick"])],64)):M("",!0)]),_:1},512),s(K,{class:"share-api-use-doc",modelValue:o.showAddApiDoc,"onUpdate:modelValue":t[4]||(t[4]=h=>o.showAddApiDoc=h),title:"API使用文档",size:"50%"},{default:a(()=>[s(J,{"show-api-select":!1})]),_:1},8,["modelValue"])],64)}const Ae=Z(te,[["render",le],["__scopeId","data-v-c0f45385"]]);export{Ae as A};
