import{S}from"../../../../sortablejs.C83syoBY.js";import{R as O}from"./RequestDetail.DNosiPja.js";import{R as x}from"./ResponseDetail.BPanCwJ5.js";import{r as M}from"../../../../stores/request.server.Jl9Oinz8.js";import{b as E,u as L,d as P}from"../../../../resources/global/global.util.CdGU-cda.js";import{h as D,c as B,f as $,g as K,l as V,e as F,u as U}from"../util/request.utils.C-Y0rqBy.js";import{_ as N}from"../../../../components/address/S3Address.C-l0MtE3.js";import{s as j}from"../../../../pinia.C4zkjZtA.js";import{a as k,e as o,l as w,w as r,F as T,a8 as z,r as p,x as H,o as C,h as J,c as I,j as G,y as Q,f as d,t as q}from"../../../../vue.B9VI7CMM.js";import"./detail/Query.D3sz3CNX.js";import"./detail/ApiTable.3WBV7yFb.js";import"../../../../resources/util/snowflake.util.CMOmz3k-.js";import"../../../../resources/util/machine.code.util.H1Gamunq.js";import"../../../../resources/util/crypto.util.De05Bpu1.js";import"../../../../crypto.tqJ8oQci.js";import"../../../../antlr4.BZgrZd6q.js";import"../../../../resources/util/map.DsJxN4sz.js";import"./detail/Header.BZcc_YOh.js";import"./detail/Body.CEqaWa6E.js";import"./detail/Java2Api.DJKrZZe0.js";import"../../../../resources/antlr4/java8/Java8Lexer.DkrHY6x9.js";import"../../../../resources/antlr4/java8/Java8Parser.CF2-JRMB.js";import"../../../../resources/antlr4/java8/Java8ParserListener.qTYW0woq.js";import"../../../../resources/antlr4/java8/Java8ParserVisitor.CeAJKNNA.js";import"../../../../resources/antlr4/java8/impl/java8.listener.D8_Av1r5.js";import"./detail/ViewApi.CBmvgeqT.js";import"./detail/Detail.C7-F6ZUa.js";import"../../../../resources/util/cache.indexeddb.CXuVJu8M.js";import"../../../../resources/util/timer.util.DJ34cZ81.js";import"../../../../js.DlQi3gKf.js";import"../../../../md5.DCeuUgf6.js";import"../../../../charenc.DHEmDxqN.js";import"../../../../../../public.scmp.config.js";import"../../../../mitt.C1xD_ZTF.js";const W={name:"RequestTabs",components:{RequestDetail:O,ResponseDetail:x},setup(){const{defaultApiDetail:e,clearApiCache:t,getFileDetail:i,setResDetailOnce:n,setRunDetail:l,getRunDetail:a,setOtherConfigCache:u}=M(),{isShare:g,apiDetail:f,apiDetailClone:y,selectEntityId:_,entityMap:m,apiChangeDetail:c}=j(M());return{defaultApiDetail:e,isShare:g,apiDetail:f,apiDetailClone:y,selectEntityId:_,entityMap:m,apiChangeDetail:c,clearApiCache:t,getFileDetail:i,setResDetailOnce:n,setRunDetail:l,getRunDetail:a,setOtherConfigCache:u}},emits:[],props:{},data(){return{tooltipData:{},showTooltip:!1,tooltipRef:void 0,showTooltipDebounce:P((e,t)=>{if(!e)return this.showTooltip=!1;this.tooltipData=t,this.tooltipRef=e,this.showTooltip=!!t.name},.3)}},computed:{tabsClosable(){return!this.isShare&&this.selectEntityId!==-1}},watch:{selectEntityId:{immediate:!0,handler(e,t){if(!this.entityMap.contains(e))return;let i;this.apiChangeDetail.contains(e)&&(i=this.apiChangeDetail.get(e).nApi),this.apiDetail=i||this.entityMap.get(e),this.isShare||this.setOtherConfigCache("RequestApi_Select_Flag",e),this.apiDetailClone=this.apiChangeDetail.getOrDefault(e,()=>({oApi:E(this.entityMap.get(e))})).oApi}}},created(){this.isShare||document.addEventListener("keydown",this.onKeyDownSave)},mounted(){if(this.isShare)return;const e=this.$refs.apiRequestTabs.$el.querySelector(".el-tabs__nav");new S(e,{animation:150,handle:".label-wrapper",draggable:".el-tabs__item",onEnd:this.sortableOnEnd})},beforeUnmount(){this.isShare||document.removeEventListener("keydown",this.onKeyDownSave)},methods:{sortableOnEnd(e){e.oldIndex!==e.newIndex&&(this.entityMap.shiftElements(e.oldIndex,e.newIndex),this.setOtherConfigCache("Open_Api_Sort",z(this.entityMap.keys())))},buildReq(e){const{domain:t,contextPath:i,prefix:n,url:l,sse:a}=e.config,u=L(t,i,n,l),g=new URL(u).hostname,f=U(g),y={decryEncryAttempt:this.$decryEncryAttempt,responseType:"arraybuffer",ignore401:!0},_=this.getFileDetail(e.id),m=f?$(1,e,_):K(u,1,this.$decryEncryAttempt,e,_),{method:c,headers:R,params:A,data:v}=m,s=h=>this.setResDetailOnce(e.id,D(h));return f?V(c,u,R,A,v):a?F(this.$baseUrl,"POST","request/api/reqSSE",m,y,s):this.$http.post("request/api/req",m,y)},batchRunOpenApi(e){e==="waitLast"?this.entityMap.values().reduce((t,i)=>t.then(()=>(this.setRunDetail(i.id,!0),this.buildReq(i).then(n=>n?this.setResDetailOnce(i.id,D(n)):void 0).catch(n=>this.setResDetailOnce(i.id,B(n))).finally(()=>{this.setRunDetail(i.id,!1),this.$message({message:`API[ ${i.name} ]已执行,请查看对应的标签页`,type:"success"})}))),Promise.resolve()).then(()=>({})):e==="and"&&this.entityMap.values().forEach(t=>{this.setRunDetail(t.id,!0),this.buildReq(t).then(i=>{i&&this.setResDetailOnce(t.id,D(i))}).finally(()=>{this.setRunDetail(t.id,!1),this.$message({message:`API[ ${t.name} ]已执行,请查看对应的标签页`,type:"success"})})})},onKeyDownSave(e){if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="s"){if(e.preventDefault(),!this.apiChangeDetail.contains(this.apiDetail.id))return;this.updateApi(this.apiDetail).then(t=>{this.apiDetailClone=E(this.apiDetail),this.apiChangeDetail.remove(this.apiDetail.id),this.$message({type:"success",showClose:!0,message:"更新完成",center:!0})})}},apiTabOnMouseover(e,t){this.showTooltipDebounce(e.currentTarget,t)},closeApi(e,t){let i=this.entityMap.keys();t==="other"?this.entityMap.deleteOther(e):t==="left"?this.entityMap.deleteLeft(e):t==="right"&&this.entityMap.deleteRight(e);const n=this.entityMap.keys();i.filter(l=>!n.includes(l)).forEach(l=>this.clearApiCache()),this.entityMap.contains(this.selectEntityId)||(this.selectEntityId=n[0])},closeAllApi(e){this.entityMap.deleteAll(),this.entityMap.put(-1,this.defaultApiDetail),this.selectEntityId=-1,this.clearApiCache()},closeThisApi(e){const{id:t}=this.entityMap.delete(e);this.selectEntityId===t&&(this.selectEntityId=this.entityMap.getKey(e===0?0:e-1)),this.entityMap.isEmpty()&&(this.entityMap.put(-1,this.defaultApiDetail),this.selectEntityId=-1),this.clearApiCache(t)},showRightMenu(e,t,i){e.preventDefault(),!(this.isShare||t.id===-1)&&this.$refs.rightMenu.click(e,i)},entityRemove(e){const t=this.entityMap.indexOf(e),i=this.entityMap.get(e);if(this.isShare||!this.apiChangeDetail.contains(e))return this.closeThisApi(t);const n={confirmButtonText:"更新",cancelButtonText:"取消",type:"warning"};this.$confirm(`API: ${i.name}`,"API更新未保存",n).then(l=>this.updateApi(this.apiChangeDetail.get(i.id).nApi)).then(l=>this.$message({type:"success",showClose:!0,message:"更新完成",center:!0})).catch(()=>{}).finally(()=>this.closeThisApi(t))},updateApi(e){const t=[e.name,e.config.url].filter(Boolean).join(" ");return this.update("tb_request_api.update",{...e,search:t})}}},X=["onContextmenu","onMouseenter"],Y={class:"tabs-content"};function Z(e,t,i,n,l,a){const u=p("el-text"),g=p("el-tab-pane"),f=p("el-tabs"),y=p("el-tooltip"),_=p("request-detail"),m=p("response-detail"),c=p("el-link"),R=p("s3-icon"),A=p("s3-right-menu"),v=H("loading");return C(),k(T,null,[o(f,{type:"card",class:"request-tabs",ref:"apiRequestTabs",modelValue:n.selectEntityId,"onUpdate:modelValue":t[1]||(t[1]=s=>n.selectEntityId=s),closable:a.tabsClosable,onTabRemove:a.entityRemove},{default:r(()=>[(C(!0),k(T,null,J(n.entityMap.values(),(s,h)=>(C(),I(g,{key:s.id,label:s.name,name:s.id},{label:r(()=>[w("div",{class:"label-wrapper",onContextmenu:b=>a.showRightMenu(b,s,h),onMouseenter:b=>a.apiTabOnMouseover(b,s),onMouseleave:t[0]||(t[0]=b=>l.showTooltipDebounce())},[w("div",{style:Q({opacity:n.apiChangeDetail.contains(s.id)?1:0,height:"100%"})},"*",4),G((C(),I(u,{class:"doc-method","data-text":s.config.method},{default:r(()=>[d(q(s.config.method),1)]),_:2},1032,["data-text"])),[[v,n.getRunDetail(s.id).loading]]),o(u,{class:"title",truncated:""},{default:r(()=>[d(q(s.name),1)]),_:2},1024)],40,X)]),_:2},1032,["label","name"]))),128))]),_:1},8,["modelValue","closable","onTabRemove"]),o(y,{visible:l.showTooltip,"virtual-ref":l.tooltipRef,content:l.tooltipData.name,placement:"bottom",effect:"customized"},null,8,["visible","virtual-ref","content"]),w("div",Y,[o(_),o(m)]),o(A,{ref:"rightMenu"},{default:r(({scope:s})=>[o(c,{icon:"Close",underline:!1,onClick:h=>a.closeThisApi(s)},{default:r(()=>[d("关闭文档")]),_:2},1032,["onClick"]),o(c,{icon:"Close",underline:!1,onClick:h=>a.closeApi(s,"other")},{default:r(()=>[d("关闭其他文档")]),_:2},1032,["onClick"]),o(c,{icon:"Close",underline:!1,onClick:h=>a.closeAllApi(s,"all")},{default:r(()=>[d("关闭全部文档")]),_:2},1032,["onClick"]),o(c,{icon:"Close",underline:!1,onClick:h=>a.closeApi(s,"left")},{default:r(()=>[d("关闭左侧文档")]),_:2},1032,["onClick"]),o(c,{icon:"Close",underline:!1,onClick:h=>a.closeApi(s,"right")},{default:r(()=>[d("关闭右侧文档")]),_:2},1032,["onClick"]),o(c,{icon:"Right",divided:"",underline:!1,onClick:t[2]||(t[2]=h=>a.batchRunOpenApi("waitLast"))},{default:r(()=>[d("顺序执行打开的API")]),_:1}),o(c,{underline:!1,onClick:t[3]||(t[3]=h=>a.batchRunOpenApi("and"))},{default:r(()=>[o(R,{icon:"s_turn_left"}),d("并行执行打开的API")]),_:1})]),_:1},512)],64)}const xe=N(W,[["render",Z],["__scopeId","data-v-792c94de"]]);export{xe as default};
