import{a as M,e as o,l as D,w as r,F as E,a9 as S,aa as O,a8 as x,r as p,z as L,o as C,h as P,c as k,j as B,A as $,f as d,t as T}from"../../../../.store.ssRjOe-B.js";import{R as K}from"./RequestDetail.D_vXICnH.js";import{R as V}from"./ResponseDetail.ByklGj7k.js";import{r as I}from"../../../../stores/request.server.apbYzn03.js";import{b as q,u as F,a as U}from"../../../../resources/global/global.util.BDToHPEB.js";import{h as w,c as N,f as z,g as j,l as H,e as J,u as G}from"../util/request.utils.CJX_gtFp.js";import{_ as Q}from"../../../../components/address/S3Address.Dp8cFelg.js";import"./detail/Query.iS-W-L7j.js";import"./detail/ApiTable.D7fy3Poe.js";import"../../../../resources/util/snowflake.util.BS7FKuq4.js";import"../../../../resources/util/machine.code.util.D8YEvaCo.js";import"../../../../resources/util/crypto.util.C7ecaPji.js";import"../../../../resources/util/map.DsJxN4sz.js";import"./detail/Header.ZXp1YzMC.js";import"./detail/Body.4rgV3ihS.js";import"./detail/Java2Api.Bq15W0K3.js";import"../../../../resources/antlr4/java8/Java8Lexer.B8YN2h1p.js";import"../../../../resources/antlr4/java8/Java8Parser.CxsTCjtU.js";import"../../../../resources/antlr4/java8/Java8ParserListener.B3eCXg52.js";import"../../../../resources/antlr4/java8/Java8ParserVisitor.CWonBG_x.js";import"../../../../resources/antlr4/java8/impl/java8.listener.B3BAfUTP.js";import"./detail/ViewApi.qlAuGtR9.js";import"./detail/Detail.wu9HawRU.js";import"../../../../resources/util/cache.indexeddb.CXuVJu8M.js";import"../../../../resources/util/timer.util.DJ34cZ81.js";import"../../../../../../public.scmp.config.js";const W={name:"RequestTabs",components:{RequestDetail:K,ResponseDetail:V},setup(){const{defaultApiDetail:e,clearApiCache:t,getFileDetail:i,setResDetailOnce:n,setRunDetail:l,getRunDetail:a,setOtherConfigCache:u}=I(),{isShare:g,apiDetail:m,apiDetailClone:y,selectEntityId:_,entityMap:f,apiChangeDetail:h}=x(I());return{defaultApiDetail:e,isShare:g,apiDetail:m,apiDetailClone:y,selectEntityId:_,entityMap:f,apiChangeDetail:h,clearApiCache:t,getFileDetail:i,setResDetailOnce:n,setRunDetail:l,getRunDetail:a,setOtherConfigCache:u}},emits:[],props:{},data(){return{tooltipData:{},showTooltip:!1,tooltipRef:void 0,showTooltipDebounce:U((e,t)=>{if(!e)return this.showTooltip=!1;this.tooltipData=t,this.tooltipRef=e,this.showTooltip=!!t.name},.3)}},computed:{tabsClosable(){return!this.isShare&&this.selectEntityId!==-1}},watch:{selectEntityId:{immediate:!0,handler(e,t){if(!this.entityMap.contains(e))return;let i;this.apiChangeDetail.contains(e)&&(i=this.apiChangeDetail.get(e).nApi),this.apiDetail=i||this.entityMap.get(e),this.isShare||this.setOtherConfigCache("RequestApi_Select_Flag",e),this.apiDetailClone=this.apiChangeDetail.getOrDefault(e,()=>({oApi:q(this.entityMap.get(e))})).oApi}}},created(){this.isShare||document.addEventListener("keydown",this.onKeyDownSave)},mounted(){if(this.isShare)return;const e=this.$refs.apiRequestTabs.$el.querySelector(".el-tabs__nav");new O(e,{animation:150,handle:".label-wrapper",draggable:".el-tabs__item",onEnd:this.sortableOnEnd})},beforeUnmount(){this.isShare||document.removeEventListener("keydown",this.onKeyDownSave)},methods:{sortableOnEnd(e){e.oldIndex!==e.newIndex&&(this.entityMap.shiftElements(e.oldIndex,e.newIndex),this.setOtherConfigCache("Open_Api_Sort",S(this.entityMap.keys())))},buildReq(e){const{domain:t,contextPath:i,prefix:n,url:l,sse:a}=e.config,u=F(t,i,n,l),g=new URL(u).hostname,m=G(g),y={decryEncryAttempt:this.$decryEncryAttempt,responseType:"arraybuffer",ignore401:!0},_=this.getFileDetail(e.id),f=m?z(1,e,_):j(u,1,this.$decryEncryAttempt,e,_),{method:h,headers:R,params:A,data:v}=f,s=c=>this.setResDetailOnce(e.id,w(c));return m?H(h,u,R,A,v):a?J(this.$baseUrl,"POST","request/api/reqSSE",f,y,s):this.$http.post("request/api/req",f,y)},batchRunOpenApi(e){e==="waitLast"?this.entityMap.values().reduce((t,i)=>t.then(()=>(this.setRunDetail(i.id,!0),this.buildReq(i).then(n=>n?this.setResDetailOnce(i.id,w(n)):void 0).catch(n=>this.setResDetailOnce(i.id,N(n))).finally(()=>{this.setRunDetail(i.id,!1),this.$message({message:`API[ ${i.name} ]已执行,请查看对应的标签页`,type:"success"})}))),Promise.resolve()).then(()=>({})):e==="and"&&this.entityMap.values().forEach(t=>{this.setRunDetail(t.id,!0),this.buildReq(t).then(i=>{i&&this.setResDetailOnce(t.id,w(i))}).finally(()=>{this.setRunDetail(t.id,!1),this.$message({message:`API[ ${t.name} ]已执行,请查看对应的标签页`,type:"success"})})})},onKeyDownSave(e){if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="s"){if(e.preventDefault(),!this.apiChangeDetail.contains(this.apiDetail.id))return;this.updateApi(this.apiDetail).then(t=>{this.apiDetailClone=q(this.apiDetail),this.apiChangeDetail.remove(this.apiDetail.id),this.$message({type:"success",showClose:!0,message:"更新完成",center:!0})})}},apiTabOnMouseover(e,t){this.showTooltipDebounce(e.currentTarget,t)},closeApi(e,t){let i=this.entityMap.keys();t==="other"?this.entityMap.deleteOther(e):t==="left"?this.entityMap.deleteLeft(e):t==="right"&&this.entityMap.deleteRight(e);const n=this.entityMap.keys();i.filter(l=>!n.includes(l)).forEach(l=>this.clearApiCache()),this.entityMap.contains(this.selectEntityId)||(this.selectEntityId=n[0])},closeAllApi(e){this.entityMap.deleteAll(),this.entityMap.put(-1,this.defaultApiDetail),this.selectEntityId=-1,this.clearApiCache()},closeThisApi(e){const{id:t}=this.entityMap.delete(e);this.selectEntityId===t&&(this.selectEntityId=this.entityMap.getKey(e===0?0:e-1)),this.entityMap.isEmpty()&&(this.entityMap.put(-1,this.defaultApiDetail),this.selectEntityId=-1),this.clearApiCache(t)},showRightMenu(e,t,i){e.preventDefault(),!(this.isShare||t.id===-1)&&this.$refs.rightMenu.click(e,i)},entityRemove(e){const t=this.entityMap.indexOf(e),i=this.entityMap.get(e);if(this.isShare||!this.apiChangeDetail.contains(e))return this.closeThisApi(t);const n={confirmButtonText:"更新",cancelButtonText:"取消",type:"warning"};this.$confirm(`API: ${i.name}`,"API更新未保存",n).then(l=>this.updateApi(this.apiChangeDetail.get(i.id).nApi)).then(l=>this.$message({type:"success",showClose:!0,message:"更新完成",center:!0})).catch(()=>{}).finally(()=>this.closeThisApi(t))},updateApi(e){const t=[e.name,e.config.url].filter(Boolean).join(" ");return this.update("tb_request_api.update",{...e,search:t})}}},X=["onContextmenu","onMouseenter"],Y={class:"tabs-content"};function Z(e,t,i,n,l,a){const u=p("el-text"),g=p("el-tab-pane"),m=p("el-tabs"),y=p("el-tooltip"),_=p("request-detail"),f=p("response-detail"),h=p("el-link"),R=p("s3-icon"),A=p("s3-right-menu"),v=L("loading");return C(),M(E,null,[o(m,{type:"card",class:"request-tabs",ref:"apiRequestTabs",modelValue:n.selectEntityId,"onUpdate:modelValue":t[1]||(t[1]=s=>n.selectEntityId=s),closable:a.tabsClosable,onTabRemove:a.entityRemove},{default:r(()=>[(C(!0),M(E,null,P(n.entityMap.values(),(s,c)=>(C(),k(g,{key:s.id,label:s.name,name:s.id},{label:r(()=>[D("div",{class:"label-wrapper",onContextmenu:b=>a.showRightMenu(b,s,c),onMouseenter:b=>a.apiTabOnMouseover(b,s),onMouseleave:t[0]||(t[0]=b=>l.showTooltipDebounce())},[D("div",{style:$({opacity:n.apiChangeDetail.contains(s.id)?1:0,height:"100%"})},"*",4),B((C(),k(u,{class:"doc-method","data-text":s.config.method},{default:r(()=>[d(T(s.config.method),1)]),_:2},1032,["data-text"])),[[v,n.getRunDetail(s.id).loading]]),o(u,{class:"title",truncated:""},{default:r(()=>[d(T(s.name),1)]),_:2},1024)],40,X)]),_:2},1032,["label","name"]))),128))]),_:1},8,["modelValue","closable","onTabRemove"]),o(y,{visible:l.showTooltip,"virtual-ref":l.tooltipRef,content:l.tooltipData.name,placement:"bottom",effect:"customized"},null,8,["visible","virtual-ref","content"]),D("div",Y,[o(_),o(f)]),o(A,{ref:"rightMenu"},{default:r(({scope:s})=>[o(h,{icon:"Close",underline:!1,onClick:c=>a.closeThisApi(s)},{default:r(()=>[d("关闭文档")]),_:2},1032,["onClick"]),o(h,{icon:"Close",underline:!1,onClick:c=>a.closeApi(s,"other")},{default:r(()=>[d("关闭其他文档")]),_:2},1032,["onClick"]),o(h,{icon:"Close",underline:!1,onClick:c=>a.closeAllApi(s,"all")},{default:r(()=>[d("关闭全部文档")]),_:2},1032,["onClick"]),o(h,{icon:"Close",underline:!1,onClick:c=>a.closeApi(s,"left")},{default:r(()=>[d("关闭左侧文档")]),_:2},1032,["onClick"]),o(h,{icon:"Close",underline:!1,onClick:c=>a.closeApi(s,"right")},{default:r(()=>[d("关闭右侧文档")]),_:2},1032,["onClick"]),o(h,{icon:"Right",divided:"",underline:!1,onClick:t[2]||(t[2]=c=>a.batchRunOpenApi("waitLast"))},{default:r(()=>[d("顺序执行打开的API")]),_:1}),o(h,{underline:!1,onClick:t[3]||(t[3]=c=>a.batchRunOpenApi("and"))},{default:r(()=>[o(R,{icon:"s_turn_left"}),d("并行执行打开的API")]),_:1})]),_:1},512)],64)}const Me=Q(W,[["render",Z],["__scopeId","data-v-510ab31f"]]);export{Me as default};
