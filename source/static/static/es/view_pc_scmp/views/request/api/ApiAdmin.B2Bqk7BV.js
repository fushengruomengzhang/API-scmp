import{l as W,e as b,u as P,s as G,d as H}from"../../../../resources/global/global.util.CdGU-cda.js";import{E as Q}from"./detail/EditApi.D4w0lEmC.js";import{r as T}from"../../../../stores/request.server.Jl9Oinz8.js";import{t as X,a as E}from"../util/request.utils.C-Y0rqBy.js";import Y from"../doc/ApiDocEditor.BuC00VTu.js";import{s as Z}from"../../../../resources/util/snowflake.util.CMOmz3k-.js";import{_ as $}from"../../../../components/address/S3Address.C-l0MtE3.js";import{s as ee}from"../../../../pinia.C4zkjZtA.js";import{a as x,l as y,e as s,w as a,F as N,r as l,x as te,o as _,c as k,j as M,f,t as v,d as O}from"../../../../vue.B9VI7CMM.js";const ie={name:"ApiAdmin",components:{ApiDocEditor:Y,EditApi:Q},setup(){const{reset:e,cacheId:t,delCacheId:i,getAllCacheId:d,defaultApiDetail:o,getOtherConfigCache:n}=T(),{selectEntityId:c,selectParentId:p,entityMap:h,refreshApiTree:w,domainOptions:C,apiDocDetail:A,batchReqNum:D}=ee(T());return{defaultApiDetail:o,selectEntityId:c,selectParentId:p,entityMap:h,refreshApiTree:w,domainOptions:C,batchReqNum:D,cacheId:t,delCacheId:i,getAllCacheId:d,apiDocDetail:A,getOtherConfigCache:n,reset:e}},emits:[],props:{},data(){return{showTooltip:!1,tooltipRef:void 0,tooltipData:{},searchText:void 0,edit:{entity:{},visible:!1},apiData:[],treeProps:{children:"children",isLeaf:e=>e.type==="api",label:"name"},checkApi:!1,checkApiList:[],sharePath:void 0,showAddApiDoc:!1,showTooltipDebounce:H((e,t)=>{if(!e)return this.showTooltip=!1;this.tooltipRef=e,this.tooltipData=t,this.showTooltip=!0},.3),copyOptions:{groupId:Z("copy"),getElement:e=>e.parentElement,options:{text:e=>this.sharePath},onSuccess:e=>this.$message({type:"success",showClose:!0,message:"路径已生成",center:!0})}}},computed:{batchShareDisabled(){return!this.checkApi||!this.checkApiList.length}},watch:{searchText(e){this.findByName(e)},checkApi(e,t){e||this.checkApiList.forEach(i=>this.$refs.apiTree.setChecked(i.id,!1))}},created(){this.reset(),this.findEnvConfig(),this.useAllCache(),this.initBatchReqNum(),this.refreshApiTree=this.commitCallback},mounted(){},beforeUnmount(){},methods:{apiTreeNodeOnMouseover(e,t){this.showTooltipDebounce(e.currentTarget.parentElement,t)},onApiTreeCheck(e,{checkedKeys:t,checkedNodes:i}){this.checkApiList=i},handleCommand(e){if(this.$route.name.endsWith(E)||G(.05).then(t=>this.$router.push({name:this.$route.meta.name+E})),e==="shareOpenApi")return this.shareOpenApi();if(e==="updateCheckApi")return this.updateCheckApi();if(e==="shareCheckApi")return this.shareCheckApi();if(e==="addApiDoc")return this.addApiDoc()},updateCheckApi(){return this.checkApi&&(this.checkApiList=[],this.$refs.apiTree.setCheckedKeys([],!1)),this.checkApi=!this.checkApi},addApiDoc(){const e=this.checkApiList.map(i=>i.id),t=b(e.sort().join(","));this.findOne("tb_api_docs.find",{flag:t}).then(i=>{if(i.data.id)return this.apiDocDetail=i.data;const d=X(this.checkApiList);this.apiDocDetail={parent_id:0,type:"doc",api_ids:e,flag:t,content:d}}).finally(()=>this.showAddApiDoc=!0)},findEnvConfig(){var i;if((i=this.domainOptions)!=null&&i.length)return;const e=new Promise(d=>this.findOne("tb_config.findAll",{key:"requestEnvConfig"}).then(o=>{o.data.value&&d(o.data.value)})),t=new Promise(d=>this.getOtherConfigCache("Local_Env_Config").then(o=>d(o?o.value:[])));Promise.all([e,t]).then(([d,o])=>{o.forEach(({name:n,domain:c})=>this.domainOptions.push({name:n,domain:c,localEnv:!0})),d.forEach(({name:n,domain:c})=>this.domainOptions.push({name:n,domain:c,localEnv:!1}))})},shareOpenApi(){const{origin:e,pathname:t}=window.location,i=b(this.entityMap.keys().join(","));this.sharePath=P(e,t)+`#/shareRequest?id=${i}`},shareCheckApi(){const{origin:e,pathname:t}=window.location,i=b(this.checkApiList.join(","));this.sharePath=P(e,t)+`#/shareRequest?id=${i}`},apiNodeAllowDrop(e,t,i){return t.data.type!=="api"&&i==="inner"},apiNodeDrop(e,t,i){this.$confirm(`是否拖拽 [${e.data.name}] 到 [${t.data.name}] ?`,"提示",{confirmButtonText:"是",cancelButtonText:"否",type:"warning"}).then(d=>{const o=t.data.id||0,n=e.data.id;this.update("tb_request_api.update",{id:n,parent_id:o}).then(c=>{this.entityMap.contains(n)&&(this.entityMap.get(n).parent_id=o)})}).catch(d=>{this.$refs.apiTree.reloadNode(e.data.parent_id,t.data.id)})},showRightMenu(e,t,i){var d,o,n,c;if(t.config=t.config?t.config:{},!t.config.contextPath){const p=(d=i.parent)==null?void 0:d.data;p&&(t.config.contextPath=(o=p.config)==null?void 0:o.contextPath)}if(!t.config.prefix){const p=(n=i.parent)==null?void 0:n.data;p&&(t.config.prefix=(c=p.config)==null?void 0:c.prefix)}this.$refs.rightMenu.click(e,{node:i,entity:t})},showEdit(e){e.config=e.config?e.config:{},this.edit={entity:e,visible:!0}},newChild(e,t){const i={prefix:e.config.prefix,contextPath:e.config.contextPath},d={type:t,parent_id:e.id,config:i};this.edit={entity:d,visible:!0}},refresh(e){this.$refs.apiTree.reloadNode(e)},commitCallback(e){const t=this.$refs.apiTree.getNode(e.id),i=t==null?void 0:t.parent;e.parent_id!==(i==null?void 0:i.data.id)&&(i==null||i.childNodes.removeIf(d=>d.data.id===e.id)),this.$refs.apiTree.reloadNode(e.parent_id,e.id)},findByName(e){const t=e?{search:e}:{parentId:0};this.findAll("tb_request_api.find",t).then(i=>this.apiData=W(i.data))},delFolder(e,t){this.$confirm(`确定要删除[${t.name}]吗?`,"警告",{type:"warning"}).then(i=>{this.delete("tb_request_api.delete",{id:t.id}).then(d=>{var o,n;return(n=(o=e.parent)==null?void 0:o.childNodes)==null?void 0:n.removeIf(c=>c.data.id===t.id)})}).catch(i=>{})},findByParentId(e,t){this.findAll("tb_request_api.find",{parentId:e.data.id||0}).then(i=>t(i.data))},apiNodeClick(e,t,i,d){this.$refs.rightMenu.close(),this.selectParentId=e.type!=="api"?e.id:t.parent.data.id,e.type==="api"&&(this.entityMap.contains(-1)&&this.entityMap.remove(-1),this.entityMap.contains(e.id)||this.entityMap.put(e.id,e),this.selectEntityId=e.id,this.cacheId(e.id))},useAllCache(){Promise.all([this.getAllCacheId(),this.getOtherConfigCache("Open_Api_Sort")]).then(([e,t])=>{if(!e||!e.length)return Promise.resolve();const i=(t==null?void 0:t.value)||[],d=new Map(i.map((n,c)=>[n,c])),o=e.sort((n,c)=>{const p=d.get(n.id)??1/0,h=d.get(c.id)??1/0;return p-h||(p===1/0?n.cTime-c.cTime:0)}).map(n=>n.id);return this.findAll("tb_request_api.find",{ids:o}).then(n=>Promise.resolve({data:n.data,ids:o}))}).then(e=>{var t;if(!e||!e.data.length)return(t=e==null?void 0:e.ids)==null||t.forEach(this.delCacheId),this.entityMap.put(-1,this.defaultApiDetail),this.selectEntityId=-1;this.getOtherConfigCache("RequestApi_Select_Flag").then(i=>{this.selectEntityId=i!=null&&i.value?i.value:e.data[0].id}),e.data.sort((i,d)=>e.ids.indexOf(i.id)-e.ids.indexOf(d.id)),e.data.forEach(i=>this.entityMap.put(i.id,i)),e.ids.filter(i=>!this.entityMap.contains(i)).forEach(this.delCacheId)})},initBatchReqNum(){this.getOtherConfigCache("Batch_Req_Num").then(e=>{e!=null&&e.value&&(this.batchReqNum=e.value)})}}},oe={class:"operation"},ne=["onContextmenu","onMouseenter"],se=["data-text"],ae={class:"tree-node-text"},de={style:{"white-space":"break-spaces"}};function le(e,t,i,d,o,n){const c=l("el-input"),p=l("Plus"),h=l("el-icon"),w=l("Share"),C=l("el-text"),A=l("el-dropdown-item"),D=l("Close"),q=l("Check"),B=l("Edit"),V=l("el-dropdown-menu"),L=l("el-dropdown"),R=l("Folder"),F=l("s3-tree"),S=l("s3-scroll"),j=l("el-tooltip"),U=l("edit-api"),g=l("el-link"),z=l("s3-right-menu"),K=l("api-doc-editor"),J=l("el-drawer"),I=te("copy");return _(),x(N,null,[y("div",oe,[s(c,{class:"search",modelValue:o.searchText,"onUpdate:modelValue":t[0]||(t[0]=u=>o.searchText=u),placeholder:"搜索(名称或者路径)",clearable:""},null,8,["modelValue"]),s(L,{class:"operation-dropdown","split-button":"",type:"primary",onCommand:n.handleCommand,onClick:t[1]||(t[1]=u=>o.edit={entity:{type:"folder",config:{}},visible:!0})},{dropdown:a(()=>[s(V,null,{default:a(()=>[s(A,{command:"shareOpenApi"},{default:a(()=>[M((_(),k(C,null,{default:a(()=>[s(h,null,{default:a(()=>[s(w)]),_:1}),f("分享已打开的API")]),_:1})),[[I,o.copyOptions]])]),_:1}),o.checkApi?(_(),k(A,{key:0,command:"updateCheckApi",divided:""},{default:a(()=>[s(h,null,{default:a(()=>[s(D)]),_:1}),f("关闭API选择")]),_:1})):(_(),k(A,{key:1,command:"updateCheckApi",divided:""},{default:a(()=>[s(h,null,{default:a(()=>[s(q)]),_:1}),f("选择API")]),_:1})),s(A,{command:"addApiDoc",class:"addApiDoc",disabled:n.batchShareDisabled},{default:a(()=>[s(h,null,{default:a(()=>[s(B)]),_:1}),f("编辑API使用文档")]),_:1},8,["disabled"]),s(A,{command:"shareCheckApi",disabled:n.batchShareDisabled},{default:a(()=>[M((_(),k(C,null,{default:a(()=>[s(h,null,{default:a(()=>[s(w)]),_:1}),f("分享已选择的API")]),_:1})),[[I,o.copyOptions]])]),_:1},8,["disabled"])]),_:1})]),default:a(()=>[s(h,null,{default:a(()=>[s(p)]),_:1})]),_:1},8,["onCommand"])]),s(S,{class:"api-tree"},{default:a(()=>[s(F,{class:"tree-detail","node-key":"id","highlight-current":"",ref:"apiTree","show-checkbox":o.checkApi,"check-strictly":!0,draggable:!0,data:o.apiData,props:o.treeProps,lazy:"",load:n.findByParentId,"allow-drop":n.apiNodeAllowDrop,onCheck:n.onApiTreeCheck,onNodeDrop:n.apiNodeDrop,onNodeClick:n.apiNodeClick},{default:a(({node:u,data:r})=>[y("div",{class:"node-item",onContextmenu:m=>n.showRightMenu(m,r,u),onMouseenter:m=>n.apiTreeNodeOnMouseover(m,r),onMouseleave:t[2]||(t[2]=m=>o.showTooltipDebounce())},[r.type!=="api"?(_(),k(h,{key:0,class:"isFolder"},{default:a(()=>[s(R)]),_:1})):(_(),x("span",{key:1,class:"api-method","data-text":r.config.method},v(r.config.method),9,se)),y("div",ae,[s(C,{class:"tree-node-text-wrapper",truncated:""},{default:a(()=>[f(v(r.name),1)]),_:2},1024)])],40,ne)]),_:1},8,["show-checkbox","data","props","load","allow-drop","onCheck","onNodeDrop","onNodeClick"])]),_:1}),s(j,{visible:o.showTooltip,"virtual-ref":o.tooltipRef,placement:"right",effect:"customized"},{content:a(()=>[y("span",de,v(o.tooltipData.desc||o.tooltipData.name),1)]),_:1},8,["visible","virtual-ref"]),s(U,{model:o.edit.entity,modelValue:o.edit.visible,"onUpdate:modelValue":t[3]||(t[3]=u=>o.edit.visible=u)},null,8,["model","modelValue"]),s(z,{ref:"rightMenu"},{default:a(({scope:{node:u,entity:r}})=>[r.type!=="api"?(_(),k(g,{key:0,icon:"Refresh",underline:!1,onClick:m=>n.refresh(r.id)},{default:a(()=>[f("刷新目录")]),_:2},1032,["onClick"])):O("",!0),s(g,{divided:"",icon:"Edit",underline:!1,onClick:m=>n.showEdit(r)},{default:a(()=>[f("编辑"+v(r.type==="api"?"API":"目录"),1)]),_:2},1032,["onClick"]),s(g,{icon:"Delete",underline:!1,onClick:m=>n.delFolder(u,r)},{default:a(()=>[f("删除"+v(r.type==="api"?"API":"目录"),1)]),_:2},1032,["onClick"]),r.type!=="api"?(_(),x(N,{key:1},[s(g,{divided:"",icon:"Plus",underline:!1,onClick:m=>n.newChild(r,"folder")},{default:a(()=>[f("新建子目录")]),_:2},1032,["onClick"]),s(g,{divided:"",icon:"Plus",underline:!1,onClick:m=>n.newChild(r,"api")},{default:a(()=>[f("新建子API")]),_:2},1032,["onClick"])],64)):O("",!0)]),_:1},512),s(J,{class:"share-api-use-doc",modelValue:o.showAddApiDoc,"onUpdate:modelValue":t[4]||(t[4]=u=>o.showAddApiDoc=u),title:"API使用文档",size:"50%"},{default:a(()=>[s(K,{"show-api-select":!1})]),_:1},8,["modelValue"])],64)}const ke=$(ie,[["render",le],["__scopeId","data-v-774c15d1"]]);export{ke as A};
