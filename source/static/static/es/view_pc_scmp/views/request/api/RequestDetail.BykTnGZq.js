import{b as K,u as V,e as W,a as X,c as Y}from"../../../../resources/global/global.util.CrvsVFo3.js";import{Q as Z}from"./detail/Query.B-fpzoBb.js";import{H as $}from"./detail/Header.CAE6ZL7S.js";import{B as ee}from"./detail/Body.CPj_-PzE.js";import{V as te}from"./detail/ViewApi.COP0tsSj.js";import{D as se}from"./detail/Detail.Bp1n2s64.js";import{h as R,c as U,l as ae,s as ie,d as ne,e as oe,u as le}from"../util/request.utils.Cc8QJvHY.js";import{r as S}from"../../../../stores/request.server.OPoUfqQ8.js";import{s as re}from"../../../../resources/util/snowflake.util.C4QYlgiq.js";import{s as de}from"../../../../pinia.DPawhP_y.js";import{_ as ue}from"../../../../components/address/S3Address.BvGSUWFm.js";import{a as C,l as O,e as a,w as l,F as v,r as d,q as ce,o as f,h as B,c as b,f as y,t as T,z as he,d as P,j as E}from"../../../../vue.CpRb0aFL.js";const pe={name:"RequestDetail",components:{Detail:se,ViewApi:te,Body:ee,Header:$,Query:Z},setup(){const{setResDetailOnce:t,setResDetailBatch:e,setFileDetail:i,getFileDetail:o,removeFileDetail:n,setRunDetail:s,getRunDetail:u}=S(),{isShare:c,apiDetail:h,apiDetailClone:p,domainOptions:D,selectParentId:g,apiChangeDetail:m,refreshApiTree:A,batchReqNum:_}=de(S());return{isShare:c,apiDetail:h,apiDetailClone:p,domainOptions:D,selectParentId:g,apiChangeDetail:m,refreshApiTree:A,setResDetailOnce:t,setResDetailBatch:e,setFileDetail:i,removeFileDetail:n,getFileDetail:o,setRunDetail:s,getRunDetail:u,batchReqNum:_}},emits:[],props:{},data(){return{requestActive:"Detail",methodOptions:["GET","POST","PUT","DELETE"],showViewer:!1,clipboard:void 0,commandType:void 0,apiChangeDebounce:X((t,e)=>{!Y(t,e,["update_time","config.bodyType"])?this.apiChangeDetail.put(t.id,{nApi:t,oApi:e}):this.apiChangeDetail.remove(t.id)},.2)}},computed:{loading:{get(){return this.getRunDetail(this.apiDetail.id).loading||!1},set(t){this.setRunDetail(this.apiDetail.id,t)}},domain:{get(){return this.config.domain},set(t){this.config.domain=t}},header:{get(){return this.config.header||(this.config.header=[]),this.config.header},set(t){this.config.header=t}},requestPath(){const{contextPath:t,prefix:e,url:i}=this.config;return V(t,e,i)},shareDocUrl(){const{origin:t,pathname:e}=window.location,i=W(this.apiDetail.id.toString());return V(t,e)+`#/shareRequest?id=${i}`},copyMsg(){return this.commandType==="shareApi"?"分享链接已复制":"路径已复制"},isApiUpdate(){return!this.isShare&&this.apiChangeDetail.contains(this.apiDetail.id)&&this.apiDetail.id>0},copyOptions(){return{groupId:re("copy"),getElement:t=>t.parentElement,onSuccess:t=>this.$message({type:"success",showClose:!0,center:!0,message:this.copyMsg}),options:{text:t=>this.commandType==="shareApi"?this.shareDocUrl:this.requestPath}}},config(){return this.apiDetail.config}},watch:{apiDetail:{deep:!0,handler(t,e){this.isShare||this.apiChangeDebounce(t,this.apiDetailClone)}},config(t,e){this.initActive(t)}},created(){this.initActive(this.apiDetail.config)},mounted(){},beforeUnmount(){},methods:{initActive(t){const{query:e,queryBody:i,bodyDocument:o,formBodyDocument:n,urlBodyDocument:s}=t;e&&e.length?this.requestActive="Query":(i!=null&&i.length||o!=null&&o.length||n!=null&&n.length||s!=null&&s.length)&&(this.requestActive="Body")},operationCommand(t){if(this.commandType=t,t==="showViewer")return this.showViewer=!0;if(t==="updateApi")return this.updateApi(!0);if(t==="saveApi")return this.saveApi();if(t==="batchRequest")return this.handlerRequest("batchReq")},uploadFileChange(t,e){e==="append"?this.setFileDetail(this.apiDetail.id,t):e==="remove"&&this.removeFileDetail(this.apiDetail.id,t)},buildParam(t,e=1){const i=t.config,o=i.domain;if(!o)return this.$message({type:"error",showClose:!0,message:`[${t.name}]请选择环境`,center:!0});const n=V(o,i.contextPath,i.prefix,i.url),s=new URL(n).hostname,u=le(s),c=this.config.sse,h=this.getFileDetail(t.id),p={decryEncryAttempt:this.$decryEncryAttempt,responseType:"arraybuffer",ignore401:!0},D=u?ne(t,h):oe(n,e,this.$decryEncryAttempt,t,h);return{apiDetail:t,url:n,isLocalApi:u,isSSe:c,param:D,config:p}},buildReq(t,e=1,i=!1){const{apiDetail:o,url:n,isLocalApi:s,isSSe:u,param:c,config:h}=t,{method:p,headers:D,params:g,data:m}=c,A=e===1?w=>this.setResDetailOnce(o.id,R(w)):w=>this.setResDetailBatch(o.id,R(w),i);let _;return s?_=ae(p,n,D,g,m):u?_=ie(this.$baseUrl,"POST","request/api/reqSSE",c,h,A):_=this.$http.post("request/api/req",c,h),_},reqApi(t,e,i){const o=this.buildParam(t);if(!o)return i();this.buildReq(o).then(n=>Promise.resolve(this.setResDetailOnce(t.id,R(n)))).then(n=>e?this.updateApi(!1,t):Promise.resolve()).catch(n=>this.setResDetailOnce(t.id,U(n))).finally(()=>i()||this.$message({message:"请求已执行",type:"success"}))},batchReqApi(t,e=1,i){const o=this.buildParam(t,e);if(!o)return i();const n=Array.from({length:e},s=>this.buildReq(o,e,s===0));Promise.allSettled(n).then(s=>{s.forEach(({reason:u,value:c,status:h},p)=>{if(h==="fulfilled")return this.setResDetailBatch(t.id,R(c),p===0);if(h==="rejected")return this.setResDetailBatch(t.id,U(u),p===0)})}).finally(()=>i()||this.$message({message:`${e}次请求已执行,请通过BatchResponse查看结果`,type:"success"}))},handlerRequest(t){this.loading=!0;const e=this.apiDetail,i=this.isApiUpdate,o=this.batchReqNum;this.setRunDetail(e.id,!0),new Promise((n,s)=>{try{if(t==="default")return this.reqApi(e,i,n);if(t==="batchReq")return this.batchReqApi(e,o,n)}catch(u){s(u.message||"系统发生错误,请联系管理员")}}).catch(n=>{this.$message({type:"error",showClose:!0,message:n,center:!0})}).finally(()=>{this.setRunDetail(e.id,!1)})},updateApi(t,e){e=e||this.apiDetail;const i=[e.name,e.config.url].filter(Boolean).join(" ");this.update("tb_request_api.update",{...e,search:i}).then(o=>{this.apiDetailClone.id===e.id&&(this.apiDetailClone=K(e),this.apiDetailClone.search=i),e.search=i,this.apiChangeDetail.remove(e.id),t&&this.$message({message:"更新成功",type:"success"})})},saveApi(){if(!this.apiDetail.name)return this.$message({type:"error",showClose:!0,message:"请输入名称",center:!0});if(!this.config.method)return this.$message({type:"error",showClose:!0,message:"请选择方法",center:!0});if(!this.config.contextPath)return this.$message({type:"error",showClose:!0,message:"请输入contextPath",center:!0});if(!this.config.prefix)return this.$message({type:"error",showClose:!0,message:"请输入前缀",center:!0});if(!this.config.url)return this.$message({type:"error",showClose:!0,message:"请输入路径",center:!0});this.apiDetail.parent_id=this.selectParentId,this.apiDetail.search=[this.apiDetail.name,this.config.url].join(" "),this.apiDetail.type="api",this.save("tb_request_api.save",this.apiDetail).then(t=>this.refreshApiTree(this.apiDetail)).finally(()=>this.showForm=!1)}}},me={class:"request-detail"},fe={class:"request-url"};function ge(t,e,i,o,n,s){const u=d("el-option"),c=d("el-text"),h=d("el-select"),p=d("el-input"),D=d("View"),g=d("el-icon"),m=d("el-dropdown-item"),A=d("s3-icon"),_=d("Plus"),w=d("Paperclip"),F=d("Share"),I=d("CopyDocument"),k=d("el-dropdown-menu"),L=d("el-dropdown"),Q=d("Detail"),q=d("el-tab-pane"),H=d("Header"),N=d("Query"),j=d("Body"),z=d("el-tabs"),M=d("ViewApi"),x=ce("copy");return f(),C(v,null,[O("div",me,[O("div",fe,[a(h,{class:"method",modelValue:s.config.method,"onUpdate:modelValue":e[0]||(e[0]=r=>s.config.method=r)},{label:l(()=>[a(c,{class:"doc-method","data-text":s.config.method},{default:l(()=>[y(T(s.config.method),1)]),_:1},8,["data-text"])]),default:l(()=>[(f(!0),C(v,null,B(n.methodOptions,r=>(f(),b(u,{label:r,value:r},null,8,["label","value"]))),256))]),_:1},8,["modelValue"]),a(h,{class:"domain",modelValue:s.domain,"onUpdate:modelValue":e[1]||(e[1]=r=>s.domain=r),placeholder:"请选择环境"},{default:l(()=>[(f(!0),C(v,null,B(o.domainOptions,({domain:r,name:G,isLocal:J})=>(f(),b(u,{class:he({"local-env":J}),label:G,value:r},null,8,["class","label","value"]))),256))]),_:1},8,["modelValue"]),a(p,{class:"context-path",modelValue:s.config.contextPath,"onUpdate:modelValue":e[2]||(e[2]=r=>s.config.contextPath=r),placeholder:"context-path"},null,8,["modelValue"]),a(p,{class:"prefix",modelValue:s.config.prefix,"onUpdate:modelValue":e[3]||(e[3]=r=>s.config.prefix=r),placeholder:"prefix"},null,8,["modelValue"]),a(p,{class:"url",modelValue:s.config.url,"onUpdate:modelValue":e[4]||(e[4]=r=>s.config.url=r),placeholder:"path"},null,8,["modelValue"]),a(L,{class:"send","split-button":"",disabled:!s.config.url||s.loading,onClick:e[5]||(e[5]=r=>s.handlerRequest("default")),onCommand:s.operationCommand},{dropdown:l(()=>[a(k,null,{default:l(()=>[a(m,{command:"showViewer"},{default:l(()=>[a(g,null,{default:l(()=>[a(D)]),_:1}),y("预览API")]),_:1}),o.isShare?P("",!0):(f(),b(m,{key:0,command:"batchRequest"},{default:l(()=>[a(A,{icon:"Play_One"}),y("执行"+T(o.batchReqNum)+"次",1)]),_:1})),!o.isShare&&o.apiDetail.id===-1?(f(),b(m,{key:1,command:"saveApi"},{default:l(()=>[a(g,null,{default:l(()=>[a(_)]),_:1}),y("新建API")]),_:1})):P("",!0),!o.isShare&&o.apiDetail.id!==-1?(f(),b(m,{key:2,command:"updateApi"},{default:l(()=>[a(g,null,{default:l(()=>[a(w)]),_:1}),y("更新API")]),_:1})):P("",!0),a(m,{command:"shareApi"},{default:l(()=>[E((f(),b(c,null,{default:l(()=>[a(g,null,{default:l(()=>[a(F)]),_:1}),y("分享API")]),_:1})),[[x,s.copyOptions]])]),_:1}),a(m,{command:"copyPath"},{default:l(()=>[E((f(),b(c,null,{default:l(()=>[a(g,null,{default:l(()=>[a(I)]),_:1}),y("复制路径")]),_:1})),[[x,s.copyOptions]])]),_:1})]),_:1})]),default:l(()=>[y("执行 ")]),_:1},8,["disabled","onCommand"])]),a(z,{modelValue:n.requestActive,"onUpdate:modelValue":e[7]||(e[7]=r=>n.requestActive=r),class:"request-config"},{default:l(()=>[a(q,{label:"Api Detail",name:"Detail"},{default:l(()=>[a(Q)]),_:1}),a(q,{label:"Header",name:"Header"},{default:l(()=>[a(H,{modelValue:s.header,"onUpdate:modelValue":e[6]||(e[6]=r=>s.header=r)},null,8,["modelValue"])]),_:1}),a(q,{label:"Query",name:"Query"},{default:l(()=>[a(N)]),_:1}),a(q,{label:"Body",name:"Body"},{default:l(()=>[a(j,{onUpdateApi:s.updateApi,onUploadFileChange:s.uploadFileChange},null,8,["onUpdateApi","onUploadFileChange"])]),_:1})]),_:1},8,["modelValue"])]),a(M,{modelValue:n.showViewer,"onUpdate:modelValue":e[8]||(e[8]=r=>n.showViewer=r)},null,8,["modelValue"])],64)}const xe=ue(pe,[["render",ge],["__scopeId","data-v-22c44a5f"]]);export{xe as R};
